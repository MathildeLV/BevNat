---
title: 'Sensitivity Analysis: primiparous women'
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Birthweight
## test with univariate analysis
### all parities
```{r}
m_BW_all_parities_univ <- bam(BW ~ s(birth_Y_M_num), data=bevn_eco_in7)
```

### primiparous women
```{r}
summary(m_BW_all_parities_univ)
m_BW_primiparous_univ <- bam(BW ~ s(birth_Y_M_num), data=bevn_eco_in7_primiparous) 
  summary(m_BW_primiparous_univ)
```
Without multiple adjustment, first parities women have indeed lower birthweight babies (intercept 3265g) than all-parities women (intercept 3332g).

## model with the other covariates
```{r}
m_BW_primiparous <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, data=bevn_eco_in7_primiparous) 
  summary(m_BW_primiparous)
  gam.check(m_BW_primiparous) 
  #plot(m_BW_bam5_2,  select=1, shift = coef(m_BW_bam5_2)[1], shade = TRUE, shade.col = "lightblue") #ga

# extracting the plot information
plot_m_BW_primiparous_GA <- GAM_plot_function_continuous(m_BW_primiparous, 1) # GA
plot_m_BW_primiparous_mat_age <- GAM_plot_function_continuous(m_BW_primiparous, 2) # mat age
plot_m_BW_primiparous_time <- GAM_plot_function_continuous(m_BW_primiparous, 3) #time
plot_m_BW_primiparous_month <- GAM_plot_function_continuous(m_BW_primiparous, 4) # seasonality
plot_m_BW_primiparous_ssep <- GAM_plot_function_continuous(m_BW_primiparous, 5) # ssep
plot_m_BW_primiparous_altitude <- GAM_plot_function_continuous(m_BW_primiparous, 6) # altitude
```

## Graph Gestational age X birthweight

```{r}
plot_BW_primiparous_GA <- ggplot(data=plot_m_BW_primiparous_GA)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Gestational age (weeks)")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5)) +
   scale_y_continuous(breaks=seq(0,5000,by=500)) +
  ggtitle("Birthweight depending on gestational age, among primiparous women")
plot_BW_primiparous_GA
```

## Graph maternal age variable X BW

```{r}
plot_BW_primiparous_mat_age <- ggplot(data=plot_m_BW_primiparous_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Maternal age (years)")+
  ylab("Birthweight (g)")+
  scale_colour_manual('age', values =c("#9557DC"))+
  scale_fill_manual('age', values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5)) +
  scale_y_continuous(breaks=seq(0,4000,by=20)) +
  ggtitle("Birthweight depending on maternal age, among primiparous women")
plot_BW_primiparous_mat_age
```

## Graph time X birthweight

```{r}
x_date <-   bevn_eco_in7_primiparous %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_BW_primiparous <- plot_m_BW_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_BW_primiparous_time <- ggplot(data=plot_data_BW_primiparous)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Birthweight (g)")+
  scale_colour_manual('BW',  #colour manual is for the line
                      # labels=c("fully adjusted","95% CI","95% CI"),
                      values =c("#9557DC"))+
  scale_fill_manual('BW',                        # fill is for CI
                    # labels=c("fully adjusted","95% CI","95% CI"),  
                    values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  ggtitle("Birthweight through time, among primiparous women")
plot_BW_primiparous_time
```

## Graph seasonality X birthweight

```{r}
plot_BW_primiparous_month <- ggplot(data=plot_m_BW_primiparous_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Month")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1)) +
  scale_y_continuous(breaks=seq(0,4000,by=5)) +
  ggtitle("Birthweight seasonal trend, among primiparous women")
plot_BW_primiparous_month
```

## Graph SSEP X birthweight

```{r}
plot_BW_primiparous_ssep <- ggplot(data=plot_m_BW_primiparous_ssep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("SSEP")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(23,100,by=5)) +
  scale_y_continuous(breaks=seq(0,4000,by=20)) +
  ggtitle("Birthweight depending on SSEP, among primiparous women")
plot_BW_primiparous_ssep
```

## Graph altitude X birthweight

```{r}
plot_BW_primiparous_altitude <- ggplot(data=plot_m_BW_primiparous_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Altitude (MASL)")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200)) +
  scale_y_continuous(breaks=seq(0,4000,by=40)) +
  ggtitle("Birthweight depending on altitude, among primiparous women")
plot_BW_primiparous_altitude
```

## Table summarizing the birthweight outcome model

```{r}
  beta <- coef(m_BW_primiparous)
  Vb <- vcov(m_BW_primiparous, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 584156
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  tab_BW_primiparous <- round(head(my.ci,15), 2)
```

```{r}
tab_BW_primiparous['variable'] <- c("Intercept", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_BW_primiparous['category'] <- c(" ", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_BW_primiparous<-tab_BW_primiparous[, c('variable', "category", "beta", "lci","uci", "d")]

BW_primiparous_gt <- tab_BW_primiparous %>%
  gt()%>%
  tab_header(title="Birthweight GAM, among primiparous women") %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 5, 11, 13, 15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 6, 7, 8, 9, 10, 12, 14)))
BW_primiparous_gt

BW_estimates_primiparous_gt <- BW_primiparous_gt%>%
  gtsave(here("output/primiparous_women", "BW_estimates_primiparous_gt.html"))
```


# Preterm birth
## test with univariate analysis
```{r}
m_PTB_all_parities_univ <- bam(PTB ~ sex, family="binomial", data=bevn_eco_in7) 
  summary(m_PTB_all_parities_univ)
  OR <- exp(coef(m_PTB_all_parities_univ))
  beta <- coef(m_PTB_all_parities_univ)
  Vb <- vcov(m_PTB_all_parities_univ, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  PTB_all_parities_my.ci <- data.frame(cbind(OR, lci, uci))
  round(head(PTB_all_parities_my.ci, 2), 2)

m_PTB_primiparous_univ <- bam(PTB ~ sex, family="binomial", data=bevn_eco_in7_primiparous) 
  summary(m_PTB_primiparous_univ)
  OR <- exp(coef(m_PTB_primiparous_univ))
  beta <- coef(m_PTB_primiparous_univ)
  Vb <- vcov(m_PTB_primiparous_univ, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  PTB_primiparous <- data.frame(cbind(OR, lci, uci))
 round(head(PTB_primiparous, 2), 2)
```
Without multiple adjustment, first parities women have around the same risk than multiple parities women.

## model with multiple all other covariates
```{r echo=FALSE}
m_PTB_primiparous <- bam(PTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2) + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7_primiparous) 
  summary(m_PTB_primiparous)
plot_m_primiparous_PTB_bam_BW <- GAM_plot_function_binary(m_PTB_primiparous, 1)
plot_m_primiparous_PTB_bam_mat_age <- GAM_plot_function_binary(m_PTB_primiparous, 2)
plot_m_primiparous_PTB_bam_time <- GAM_plot_function_binary(m_PTB_primiparous, 3) 
plot_m_primiparous_PTB_bam_month <- GAM_plot_function_binary(m_PTB_primiparous, 4)
plot_m_primiparous_PTB_bam_sep <- GAM_plot_function_binary(m_PTB_primiparous, 5)
plot_m_primiparous_PTB_bam_altitude <- GAM_plot_function_binary(m_PTB_primiparous, 6) 
  
  k.check(m_PTB_primiparous) 
  concurvity(m_PTB_primiparous)
```

## Graph birthweight X preterm birth

```{r}
plot_PTB_primiparous_BW <- ggplot(data=plot_m_primiparous_PTB_bam_BW)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Birthweight (g)")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(200,7500,by=1000)) +
  ggtitle("Preterm birth depending on birthweight, among primiparous women")
plot_PTB_primiparous_BW
```

## Graph maternal age X preterm birth

```{r}
plot_PTB_primiparous_mat_age <- ggplot(data=plot_m_primiparous_PTB_bam_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Maternal age (years)")+
  ylab("Preterm birth probability")+
  scale_colour_manual('age', values =c("#9557DC"))+
  scale_fill_manual('age', values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5)) +
  ggtitle("Preterm birth depending on maternal age, among primiparous women")
plot_PTB_primiparous_mat_age
```

## Graph time variable X preterm birth

```{r}
x_date <-   bevn_eco_in7_primiparous %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_PTB_primiparous <- plot_m_primiparous_PTB_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_PTB_primiparous <- ggplot(data=plot_data_PTB_primiparous)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Preterm birth probability")+
  scale_colour_manual('PTB', values =c("#9557DC"))+
  scale_fill_manual('PTB', values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")  +
  ggtitle("Preterm birth through time, among primiparous women")
plot_PTB_primiparous
```

## Graph seasonality X preterm birth

```{r}
plot_PTB_primiparous_seasonality <- ggplot(data=plot_m_primiparous_PTB_bam_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Month")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1)) +
  ggtitle("Preterm birth seasonal trend, among primiparous women")
plot_PTB_primiparous_seasonality
```

## Graph SSEP X preterm birth

```{r}
plot_PTB_primiparous_SSEP <- ggplot(data=plot_m_primiparous_PTB_bam_sep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("SSEP")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(23,100,by=5)) +
  ggtitle("Preterm birth depending on SSEP, among primiparous women")
plot_PTB_primiparous_SSEP
```

## Graph altitude X preterm birth

```{r}
plot_PTB_primiparous_altitude <- ggplot(data=plot_m_primiparous_PTB_bam_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Altitude (MASL)")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200)) +
  ggtitle("Preterm birth depending on altitude, among primiparous women")
plot_PTB_primiparous_altitude
```

## Table summarizing the preterm birth outcome model

```{r}
  OR <- exp(coef(m_PTB_primiparous))
  beta <- coef(m_PTB_primiparous)
  Vb <- vcov(m_PTB_primiparous, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_PTB_primiparous <- round(head(my.ci, 15), 2)
```

```{r}
tab_PTB_primiparous['variable'] <- c("Intercept", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_PTB_primiparous['category'] <- c(" ", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_PTB_primiparous<-tab_PTB_primiparous[, c('variable', "category", "OR", "lci","uci", "d")]

PTB_primiparous_gt <- tab_PTB_primiparous %>%
  gt()%>%
  tab_header(title="Preterm birth GAM, among primiparous women") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 5, 11, 13, 15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 6, 7, 8, 9, 10, 12, 14)))
PTB_primiparous_gt

PTB_estimates_primiparous_gt <- PTB_primiparous_gt%>%
  gtsave(here("output/primiparous_women", "PTB_estimates_primiparous_gt.html"))
```

# Very PTB (<32 weeks of GA)

```{r echo=FALSE}
m_VPTB_primiparous_bam <- bam(VPTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2) + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7_primiparous) 
  summary(m_VPTB_primiparous_bam)
plot_m_VPTB_primiparous_bam_BW <- GAM_plot_function_binary(m_VPTB_primiparous_bam, 1)
plot_m_VPTB_primiparous_bam_mat_age <- GAM_plot_function_binary(m_VPTB_primiparous_bam, 2)
plot_m_VPTB_primiparous_bam_time <- GAM_plot_function_binary(m_VPTB_primiparous_bam, 3) 
plot_m_VPTB_primiparous_bam_month <- GAM_plot_function_binary(m_VPTB_primiparous_bam, 4)
plot_m_VPTB_primiparous_bam_sep <- GAM_plot_function_binary(m_VPTB_primiparous_bam, 5)
plot_m_VPTB_primiparous_bam_altitude <- GAM_plot_function_binary(m_VPTB_primiparous_bam, 6) 
  
  k.check(m_VPTB_primiparous_bam) 
  concurvity(m_VPTB_primiparous_bam)
```

## Graph time variable X very preterm birth

```{r}
x_date <-   bevn_eco_in7_primiparous %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_VPTB_primiparous <- plot_m_VPTB_primiparous_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_VPTB_primiparous <- ggplot(data=plot_data_VPTB_primiparous)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Very Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  ggtitle("VPTB (<32 weeks of GA) risk through time, among primiparous women")
plot_VPTB_primiparous
```


## Table summarizing the very preterm birth outcome model

```{r}
  OR <- exp(coef(m_VPTB_primiparous_bam))
  beta <- coef(m_VPTB_primiparous_bam)
  Vb <- vcov(m_VPTB_primiparous_bam, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_VPTB_primiparous <- round(head(my.ci, 15), 2)
```

```{r}
tab_VPTB_primiparous['variable'] <- c("Intercept",
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_VPTB_primiparous['category'] <- c(" ", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_VPTB_primiparous<-tab_VPTB_primiparous[, c('variable', "category", "OR", "lci","uci", "d")]

VPTB_primiparous_gt <- tab_VPTB_primiparous %>%
  gt()%>%
  tab_header(title="Very preterm birth GAM, among primiparous women") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 5, 11, 13, 15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 6, 7, 8, 9, 10, 12, 14)))
VPTB_primiparous_gt

VPTB_estimates_primiparous_gt <- VPTB_primiparous_gt %>%
  gtsave(here("output/primiparous_women", "VPTB_estimates_primiparous_gt.html"))
```

# Early PTB (32-34 weeks of GA)

```{r echo=FALSE}
m_EPTB_primiparous_bam <- bam(EPTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7_primiparous) 
  summary(m_EPTB_primiparous_bam)
plot_m_EPTB_primiparous_bam_BW <- GAM_plot_function_binary(m_EPTB_primiparous_bam, 1)
plot_m_EPTB_primiparous_bam_mat_age <- GAM_plot_function_binary(m_EPTB_primiparous_bam, 2)
plot_m_EPTB_primiparous_bam_time <- GAM_plot_function_binary(m_EPTB_primiparous_bam, 3) 
plot_m_EPTB_primiparous_bam_month <- GAM_plot_function_binary(m_EPTB_primiparous_bam, 4)
plot_m_EPTB_primiparous_bam_sep <- GAM_plot_function_binary(m_EPTB_primiparous_bam, 5)
plot_m_EPTB_primiparous_bam_altitude <- GAM_plot_function_binary(m_EPTB_primiparous_bam, 6) 
  
  k.check(m_EPTB_primiparous_bam) 
  concurvity(m_EPTB_primiparous_bam)
```

## Graph time variable X early preterm birth
```{r}
plot_data_EPTB_primiparous <- plot_m_EPTB_primiparous_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_EPTB_primiparous <- ggplot(data=plot_data_EPTB_primiparous)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Early Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  ggtitle("EPTB (32-34 weeks of GA) risk through time, among primiparous women")
plot_EPTB_primiparous
```

## Table summarizing the early preterm birth outcome model

```{r}
  OR <- exp(coef(m_EPTB_primiparous_bam))
  beta <- coef(m_EPTB_primiparous_bam)
  Vb <- vcov(m_EPTB_primiparous_bam, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_EPTB_primiparous <- round(head(my.ci, 15), 2)
```

```{r}
tab_EPTB_primiparous['variable'] <- c("Intercept",
                              "Sex (ref:male)", "Urban (ref:rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_EPTB_primiparous['category'] <- c(" ", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_EPTB_primiparous<-tab_EPTB_primiparous[, c('variable', "category", "OR", "lci","uci", "d")]

EPTB_primiparous_gt <- tab_EPTB_primiparous %>%
  gt()%>%
  tab_header(title="Early preterm birth GAM, among primiparous women") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
 tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 5, 11, 13, 15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 6, 7, 8, 9, 10, 12, 14)))
EPTB_primiparous_gt

EPTB_estimates_primiparous_gt <- EPTB_primiparous_gt%>%
  gtsave(here("output/primiparous_women", "EPTB_estimates_primiparous_gt.html"))
```
