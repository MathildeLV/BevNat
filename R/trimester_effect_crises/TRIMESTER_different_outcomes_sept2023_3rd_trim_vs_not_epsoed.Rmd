---
title: "Trimester effect: exposure in 3rd trim vs never exposed, BW, PTB, STILLBIRTH"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Birthweight (not adjusted for gestational age)
## First trimester exposure to the crises

```{r}
# m_BW_all_trimester <- bam(BW ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_trim_of_exposure + GR_trim_of_exposure  + covid_hosp_1st_trim_relativ + covid_hosp_last_trim_relativ, data=bevn_eco_in7) 
# m_BW_trim_covid_1st <- bam(BW ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2 + mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_trim_of_exposure + GR_trim_of_exposure  + covid_hosp_1st_trim_relativ, data=bevn_eco_in7) 
# m_BW_trim_covid_last <- bam(BW ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2 + mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_trim_of_exposure + GR_trim_of_exposure  + covid_hosp_last_trim_relativ, data=bevn_eco_in7) 
# 
# m_BW_3rd_trim_GR <- bam(BW ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_3rd_trim_vs_not_exposed  + covid_hosp_relativ_by_pregn_month, data=bevn_eco_in7) 
# 
# m_BW_3rd_trim_covid <- bam(BW ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_relativ_by_pregn_month  + covid_3rd_trim_vs_not_exposed, data=bevn_eco_in7) 
# 
#   # all possible trim combinations
#   m_BW_all_trimester_comb_GR <- bam(BW ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_all_trim_comb  + covid_hosp_relativ_by_pregn_month, data=bevn_eco_in7) 
# 
#     m_BW_all_trimester_comb_covid <- bam(BW ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_relativ_by_pregn_month  + covid_all_trim_comb, data=bevn_eco_in7) 
  m_BW_1st_trim <- bam(BW ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_first_trimester + GR_first_trimester_relativ  + covid_hosp_1st_trim_relativ, data=bevn_eco_in7) 
    summary(m_BW_1st_trim)
    # extracting the plot information
plot_m_BW_3rd_trim_mat_age <- GAM_plot_function_continuous(m_BW_1st_trim, 1) # mat age
# plot_m_BW_3rd_trim_time <- GAM_plot_function_continuous(m_BW_3rd_trim, 2) # time
plot_m_BW_3rd_trim_month <- GAM_plot_function_continuous(m_BW_1st_trim, 2) #seasonality
# plot_m_BW_3rd_trim_ssep <- GAM_plot_function_continuous(m_BW_3rd_trim, 4) # ssep
# plot_m_BW_3rd_trim_altitude <- GAM_plot_function_continuous(m_BW_3rd_trim, 5) # altitude
```

### Graph maternal age variable X BW (not adj for GA)

```{r}
plot_BW_3rd_trim_mat_age <- ggplot(data=plot_m_BW_3rd_trim_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_3rd_trim_mat_age
```


### Graph time X birthweight

```{r}
x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_3rd_trim_BW <- plot_m_BW_3rd_trim_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_BW_3rd_trim_time <- ggplot(data=plot_data_3rd_trim_BW)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Timeline (years)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3250,3550)) +
  scale_colour_manual('BW',  #colour manual is for the line
                      # labels=c("fully adjusted","95% CI","95% CI"),
                      values =c("#9557DC"))+
  scale_fill_manual('BW',                        # fill is for CI
                    # labels=c("fully adjusted","95% CI","95% CI"),  
                    values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(as.POSIXct("2007-01-01"), max(lim2)), #to force labelling from 2007 on the x axis
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom",
         legend.key.width = unit(1.5, "cm"), 
        legend.key.height = unit(0.5, "cm")) +
theme(axis.title.x = axis.title.x.position)
plot_BW_3rd_trim_time
```

### Graph seasonality X birthweight (not adj for GA)

```{r}
plot_BW_3rd_trim_month <- ggplot(data=plot_m_BW_3rd_trim_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_3rd_trim_month
```

### Graph SSEP X birthweight (not adj for GA)

```{r}
plot_BW_3rd_trim_ssep <- ggplot(data=plot_m_BW_3rd_trim_ssep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("SSEP")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,100,by=5),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_3rd_trim_ssep
```

### Graph altitude X birthweight (not adj for GA)

```{r}
plot_BW_3rd_trim_altitude <- ggplot(data=plot_m_BW_3rd_trim_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Altitude (MASL)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_3rd_trim_altitude
```

### Table summarizing the birthweight outcome model (not adj for GA)

```{r}
  beta <- coef(m_BW_1st_trim)
  Vb <- vcov(m_BW_1st_trim, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1263853 #to check
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci_BW_1st_trim <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  my.ci_BW_1st_trim <- format(round(my.ci_BW_1st_trim[18:20, c(1:4)], digits=2), nsmall=2)
```

```{r}
tab_BW_bam['Variable'] <- c("Intercept", 
                             "Time (by month)",
                            "SSEP (/10 points)", "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref 0)",
                              "COVID (continuous)")

    tab_BW_bam['Category'] <- c(" ", 
                                " ", " ", " ", 
                                "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", "1", "1","")
    tab_BW_bam<-tab_BW_bam[, c('Variable', "Category", "beta", "lci","uci", "d")]

    
tab_BW_bam_1st_trim_gt <- tab_BW_bam %>%
  gt()%>%
  tab_header(title=md(gt::html("**Table 7.A : Association between birthweight and <br> neonatal, maternal and ecological factors from a GAM (model 1.4)**")),
            subtitle =md(gt::html("first-trimester exposure to the crises <br>linear and categorical variables"))) %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 3, 4, 6, 9, 10, 11,12,13,15,17,19)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(5, 7, 8, 14,16,18,20))) %>%
   tab_options(table.width = pct(35), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_source_note(source_note = "n=1,263,853")
tab_BW_bam_1st_trim_gt

tab_BW_bam_1st_trim_gt %>%
  gtsave(here("output/tables_paper", "BW_1st_trimester_gt.html"))
tab_BW_bam_1st_trim_gt %>%
  gtsave(here("output/tables_paper", "BW_1st_trimester_gt.docx"))
```

### Table summarizing smooth term pvalues of the BW model (not adj for GA)
```{r}
 pvalues_smooth_BW_1st_trim = summary(m_BW_1st_trim)
 pvalues_smooth_BW_1st_trim <- pvalues_smooth_BW_1st_trim$s.table[,4]
  pvalues_smooth_BW_1st_trim <- format(pvalues_smooth_BW_1st_trim, scientific=FALSE)

  pvalues_smooth_BW_firs_trim_df <- data.frame(pvalues_smooth_BW_1st_trim) %>%
  dplyr::mutate(Variable=c("Maternal age", "Seasonality")) %>%
    rename(c(pvalue=(pvalues_smooth_BW_1st_trim)))%>%
    mutate(pvalue=as.numeric(pvalue)) %>%
    mutate(pvalue1=pvalue) 
  
  pvalues_smooth_BW_firs_trim_df$pvalue <-  format(round(pvalues_smooth_BW_firs_trim_df$pvalue, digits=3), nsmall=2)
  
  pvalues_smooth_BW_firs_trim_df <- pvalues_smooth_BW_firs_trim_df %>%
    mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                             (pvalue1<0.001)~ "<0.001")) 
  
  pvalues_smooth_BW_firs_trim_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_BW_firs_trim_df$pvalue1), pvalues_smooth_BW_firs_trim_df$pvalue,                                                 pvalues_smooth_BW_firs_trim_df$pvalue1))
  
  pvalues_smooth_BW_first_trim_gt <- pvalues_smooth_BW_firs_trim_df %>%
    select(-one_of('pvalue')) %>%
    rename("p-value"="pvalue1") %>%
    gt()%>% 
    tab_header(title=md(gt::html("**Table 7.B : Birthweight GAM (model 1.4)**")), 
              subtitle = "smooth variables") %>%
  tab_options(table.width = pct(15), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) 
  pvalues_smooth_BW_first_trim_gt

  pvalues_smooth_BW_first_trim_gt%>%
  gtsave(here("output/tables_paper", "pvalues_smooth_BW_first_trim_gt.html"))
  pvalues_smooth_BW_first_trim_gt%>%
    gtsave(here("output/tables_paper", "pvalues_smooth_BW_first_trim_gt.docx"))
```


## Last trimester exposure to the crises

```{r}
    m_BW_last_trim <- bam(BW ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_last_trimester + GR_last_trimester_relativ  + covid_hosp_last_trim_relativ, data=bevn_eco_in7) 
    summary(m_BW_last_trim) 
# extracting the plot information
plot_m_BW_last_trim_mat_age <- GAM_plot_function_continuous(m_BW_last_trim, 1) # mat age
plot_m_BW_last_trim_month <- GAM_plot_function_continuous(m_BW_last_trim, 2) #seasonality
```

### Graph maternal age variable X BW (not adj for GA)

```{r}
plot_BW_last_trim_mat_age <- ggplot(data=plot_m_BW_last_trim_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_last_trim_mat_age
```


### Graph seasonality X birthweight (not adj for GA)

```{r}
plot_BW_last_trim_month <- ggplot(data=plot_m_BW_last_trim_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_last_trim_month
```

### Table summarizing the birthweight outcome model (not adj for GA)

```{r}
 beta <- coef(m_BW_last_trim)
  Vb <- vcov(m_BW_last_trim, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1263853 #to check
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci_BW_last_trim <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  my.ci_BW_last_trim <- format(round(my.ci_BW_last_trim[18:20, c(1:4)], digits=2), nsmall=2)
```

```{r}
tab_BW_bam['Variable'] <- c("Intercept", 
                             "Time (by month)",
                            "SSEP (/10 points)", "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref 0)",
                              "COVID (continuous)")

    tab_BW_bam['Category'] <- c(" ", 
                                " ", " ", " ", 
                                "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", "1", "1","")
    tab_BW_bam<-tab_BW_bam[, c('Variable', "Category", "beta", "lci","uci", "d")]

    
tab_BW_bam_last_trim_gt <- tab_BW_bam %>%
  gt()%>%
  tab_header(title=md(gt::html("**Table 8.A : Association between birthweight and <br> neonatal, maternal and ecological factors from a GAM (model 1.5)**")),
            subtitle =md(gt::html("last-trimester exposure to the crises <br>linear and categorical variables"))) %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 3, 4, 6, 9, 10, 11,12,13,15,17,19)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(5, 7, 8, 14,16,18,20))) %>%
   tab_options(table.width = pct(35), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_source_note(source_note = "n=1,263,853")
tab_BW_bam_last_trim_gt

tab_BW_bam_last_trim_gt %>%
  gtsave(here("output/tables_paper", "BW_last_trimester_gt.html"))
tab_BW_bam_last_trim_gt %>%
  gtsave(here("output/tables_paper", "BW_last_trimester_gt.docx"))
```

## Table summarizing smooth term pvalues of the BW model (not adj for GA)
```{r}
 pvalues_smooth_BW_1st_trim = summary(m_BW_1st_trim)
 pvalues_smooth_BW_1st_trim <- pvalues_smooth_BW_1st_trim$s.table[,4]
  pvalues_smooth_BW_1st_trim <- format(pvalues_smooth_BW_1st_trim, scientific=FALSE)

  pvalues_smooth_BW_firs_trim_df <- data.frame(pvalues_smooth_BW_1st_trim) %>%
  dplyr::mutate(Variable=c("Maternal age", "Seasonality")) %>%
    rename(c(pvalue=(pvalues_smooth_BW_1st_trim)))%>%
    mutate(pvalue=as.numeric(pvalue)) %>%
    mutate(pvalue1=pvalue) 
  
  pvalues_smooth_BW_firs_trim_df$pvalue <-  format(round(pvalues_smooth_BW_firs_trim_df$pvalue, digits=3), nsmall=2)
  
  pvalues_smooth_BW_firs_trim_df <- pvalues_smooth_BW_firs_trim_df %>%
    mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                             (pvalue1<0.001)~ "<0.001")) 
  
  pvalues_smooth_BW_firs_trim_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_BW_firs_trim_df$pvalue1), pvalues_smooth_BW_firs_trim_df$pvalue,                                                 pvalues_smooth_BW_firs_trim_df$pvalue1))
  
  pvalues_smooth_BW_first_trim_gt <- pvalues_smooth_BW_firs_trim_df %>%
    select(-one_of('pvalue')) %>%
    rename("p-value"="pvalue1") %>%
    gt()%>% 
    tab_header(title=md(gt::html("**Table 7.B : Birthweight GAM (model 1.4)**")), 
              subtitle = "smooth variables") %>%
  tab_options(table.width = pct(15), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) 
  pvalues_smooth_BW_first_trim_gt

  pvalues_smooth_BW_first_trim_gt%>%
  gtsave(here("output/tables_paper", "pvalues_smooth_BW_first_trim_gt.html"))
  pvalues_smooth_BW_first_trim_gt%>%
    gtsave(here("output/tables_paper", "pvalues_smooth_BW_first_trim_gt.docx"))
```


# Stillbirth- simple model, without adjusting for GA
## First trimester exposure
```{r}
# m_SB_all_trimester <- bam(stillbirth ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ + sex + Urban3 + Language + mother_nationality_cat1 + civil_status3 + HW_trim_of_exposure + GR_trim_of_exposure  + covid_trim_of_exposure, family="binomial", data=bevn_eco_in7) 
# 
# m_SB_crises <- bam(stillbirth~ s(mat_age) + s(birth_Y_M_num, k=7)+ s(month, bs="cc") + s(mean_ssep2)+ s(mean_Alt_mean2) + sex + Urban3 + Language + mother_nationality_cat1 + civil_status3 + HW + GR_relativ_by_pregn_month + covid_hosp_relativ_by_pregn_month, family="binomial", data=bevn_eco_in6)
#   k.check(m_SB_crises) 
#   summary(m_SB_crises)
  
  m_SB_1st_trim <- bam(stillbirth ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+ sex + Urban3 + Language + mother_nationality_cat1 + civil_status3 + HW_first_trimester + GR_first_trimester_relativ  + covid_hosp_1st_trim_relativ, family="binomial", data=bevn_eco_in6) 
    summary(m_SB_1st_trim)

plot_m_SB_1st_trim_mat_age <- GAM_plot_function_binary(m_SB_1st_trim, 1)
plot_m_SB_1st_trim_month <- GAM_plot_function_binary(m_SB_1st_trim, 2)
  concurvity(m_SB_1st_trim, full = TRUE)
```

### Graph maternal age X Stillbirth

```{r}
plot_SB_1st_trim_mat_age <- ggplot(data=plot_m_SB_1st_trim_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.008)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_1st_trim_mat_age
```

### Graph seasonality X Stillbirth

```{r}
plot_SB_1st_trim_month <- ggplot(data=plot_m_SB_1st_trim_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.008)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_1st_trim_month
```


### Table summarizing the stillbirth outcome model

```{r echo=FALSE}
  OR <- exp(coef(m_SB_1st_trim))
  beta <- coef(m_SB_1st_trim)
  Vb <- vcov(m_SB_1st_trim, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci_SB_1st_trim <- data.frame(cbind(OR, lci, uci, d))
  my.ci_SB_1st_trim <-  format(round(my.ci_SB_1st_trim[11:13, c(1:4)], digits=2), nsmall=2)
```

## Last trimester exposure
```{r}
m_SB_last_trim <- bam(stillbirth ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+ sex + Urban3 + Language + mother_nationality_cat1 + civil_status3 + HW_last_trimester + GR_last_trimester_relativ  + covid_hosp_last_trim_relativ, family="binomial", data=bevn_eco_in6) 
    summary(m_SB_last_trim)

plot_m_SB_last_trim_mat_age <- GAM_plot_function_binary(m_SB_last_trim, 1)
plot_m_SB_last_trim_month <- GAM_plot_function_binary(m_SB_last_trim, 2)
  concurvity(m_SB_last_trim, full = TRUE)
```

### Graph maternal age X Stillbirth

```{r}
plot_SB_last_trim_mat_age <- ggplot(data=plot_m_SB_last_trim_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.008)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_1st_trim_mat_age
```

### Graph seasonality X Stillbirth

```{r}
plot_SB_last_trim_month <- ggplot(data=plot_m_SB_last_trim_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.008)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_1st_trim_month
```

### Table summarizing the stillbirth outcome model

```{r echo=FALSE}
  OR <- exp(coef(m_SB_last_trim))
  beta <- coef(m_SB_last_trim)
  Vb <- vcov(m_SB_last_trim, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci_SB_last_trim <- data.frame(cbind(OR, lci, uci, d))
  my.ci_SB_last_trim <-  format(round(my.ci_SB_last_trim[11:13, c(1:4)], digits=2), nsmall=2)
```

# Preterm birth (without adjusting for birthweight)
## First trimester exposure 
```{r echo=FALSE}
# m_PTB_trim_all_crises_cov_1st <- bam(PTB ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2 + mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_trim_of_exposure + GR_trim_of_exposure  + covid_hosp_1st_trim, family="binomial", data=bevn_eco_in7) 
#   summary(m_PTB_trim_all_crises_cov_1st)
# m_PTB_trim_all_crises_cov_last <- bam(PTB ~ s(mat_age) + birth_Y_M_num +  s(month, bs="cc") + mean_ssep2 + mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_trim_of_exposure + GR_trim_of_exposure  + covid_hosp_last_trim, family="binomial", data=bevn_eco_in7) 
# 
# m_PTB_covid_1st_trim <- bam(PTB ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2+ mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 +covid_hosp_1st_trim, family="binomial", data=bevn_eco_in7) 
# 
# m_PTB_covid_last_trim <- bam(PTB ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2+ mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 +covid_hosp_last_trim, family="binomial", data=bevn_eco_in7)
# 
# m_PTB_trim_GR <- bam(PTB ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2 + mean_Alt_mean2+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + GR_trim_of_exposure, family="binomial", data=bevn_eco_in7) 
# 
# m_PTB_trim_HW <- bam(PTB ~ s(mat_age) + birth_Y_M_num +  s(month, bs="cc") + mean_ssep2 + mean_Alt_mean2 + parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_trim_of_exposure, family="binomial", data=bevn_eco_in7) 
# 
# 
# m_PTB_GR_all_trim_comb <- bam(PTB ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_all_trim_comb  + covid_hosp_relativ_by_pregn_month, family="binomial", data=bevn_eco_in7) 
#   summary(m_PTB_GR_all_trim_comb)
#   
# m_PTB_covid_all_trim_comb <- bam(PTB ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_relativ_by_pregn_month  + covid_all_trim_comb, family="binomial", data=bevn_eco_in7) 
#   summary(m_PTB_covid_all_trim_comb)

  m_PTB_1st_trim <- bam(PTB ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+ parity_cat+ sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_first_trimester + GR_first_trimester_relativ  + covid_hosp_1st_trim_relativ, family="binomial", data=bevn_eco_in7) 

    # extracting the plot information
plot_m_PTB_1st_trim_mat_age <- GAM_plot_function_binary(m_PTB_1st_trim, 1)
plot_m_PTB_1st_trim_month <- GAM_plot_function_binary(m_PTB_1st_trim, 2)
```

### Graph maternal age X preterm birth

```{r}
plot_PTB_1st_trim_mat_age <- ggplot(data=plot_m_PTB_1st_trim_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.05,0.14)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_1st_trim_mat_age
```

### Graph seasonality X preterm birth 
```{r}
plot_PTB_1st_trim_seasonality <- ggplot(data=plot_m_PTB_1st_trim_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.05,0.14)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_1st_trim_seasonality
```

### Table summarizing the preterm birth outcome model

```{r}
  OR <- exp(coef(m_PTB_1st_trim))
  beta <- coef(m_PTB_1st_trim)
  Vb <- vcov(m_PTB_1st_trim, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci_PTB_1st_trim <- data.frame(cbind(OR, lci, uci, d))
  my.ci_PTB_1st_trim <- format(round(my.ci_PTB_1st_trim[18:20, c(1:4)], digits=2), nsmall=2)
```


## Last trimester exposure 
```{r echo=FALSE}
  m_PTB_last_trim <- bam(PTB ~ s(mat_age) + birth_Y_M_num+  s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+ parity_cat+ sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW_last_trimester + GR_last_trimester_relativ  + covid_hosp_last_trim_relativ, family="binomial", data=bevn_eco_in7) 

    # extracting the plot information
plot_m_PTB_last_trim_mat_age <- GAM_plot_function_binary(m_PTB_last_trim, 1)
plot_m_PTB_last_trim_month <- GAM_plot_function_binary(m_PTB_last_trim, 2)
```

### Graph maternal age X preterm birth

```{r}
plot_PTB_last_trim_mat_age <- ggplot(data=plot_m_PTB_last_trim_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.05,0.14)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_1st_trim_mat_age
```

### Graph seasonality X preterm birth 
```{r}
plot_PTB_last_trim_seasonality <- ggplot(data=plot_m_PTB_last_trim_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.05,0.14)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_1st_trim_seasonality
```

### Table summarizing the preterm birth outcome model

```{r}
  OR <- exp(coef(m_PTB_last_trim))
  beta <- coef(m_PTB_last_trim)
  Vb <- vcov(m_PTB_last_trim, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci_PTB_last_trim <- data.frame(cbind(OR, lci, uci, d))
  my.ci_PTB_last_trim <- format(round(my.ci_PTB_last_trim[18:20, c(1:4)], digits=2), nsmall=2)
```


