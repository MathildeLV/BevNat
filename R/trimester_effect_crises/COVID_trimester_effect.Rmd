---
title: "GAM_Covid"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
# Birthweight
## Effect of having delivery date during the pandemic (wave 1 or 2)

```{r}
#m_BW_bam_covid<- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)  +parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + COVID_first_wave + COVID_second_wave, data=bevn_eco_in7) 
#summary(m_BW_bam_covid)
#gam.check(m_BW_bam_covid) 

#  beta <- coef(m_BW_bam_covid)
  # Vb <- vcov(m_BW_bam_covid, unconditional = TRUE)
  # se <- sqrt(diag(Vb))
  # n <- 1184860
  # d <- (abs(beta)/(sqrt(n)*se))
  # my.ci.1sttrim <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  # my.ci.1sttrim <- round(head(my.ci.1sttrim,17), 2)
  # my_ci_COVID_BW_trim <- format(round(my.ci.1sttrim[16:17, c(1:4)], digits=2), nsmall=2)
  # my_ci_COVID_BW_trim
```

## Effect of being exposed during each specific trimester
Data: all births 2015-2021

### First-trimester exposure to COVID
```{r}
m_BW_bam_covid_1st_trimester <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_trimester, data=bevn_eco_in7) 
summary(m_BW_bam_covid_1st_trimester)
gam.check(m_BW_bam_covid_1st_trimester) 
 
  beta <- coef(m_BW_bam_covid_1st_trimester)
  Vb <- vcov(m_BW_bam_covid_1st_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1184860
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci.1sttrim <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  my.ci.1sttrim <- round(head(my.ci.1sttrim,17), 2)
  my.ci.covid_1st_trim <- format(round(my.ci.1sttrim[17, c(1:4)], digits=2), nsmall=2)
  my.ci.covid_1st_trim
```

### VLBW exposure to COVID during 1st trimester
```{r}
m_VLBW_bam_covid_1st_trimester <- bam(VLBW~ s(GA_weeks) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_trimester, family="binomial", data=bevn_eco_in7) 

 summary(m_VLBW_bam_covid_1st_trimester)
  
  OR <- exp(coef(m_VLBW_bam_covid_1st_trimester))
  beta <- coef(m_VLBW_bam_covid_1st_trimester)
  Vb <- vcov(m_VLBW_bam_covid_1st_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 16), 2)  
```

### Second-trimester exposure to COVID
```{r}
m_BW_bam_covid_2nd_trimester <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_second_trimester, data=bevn_eco_in7) 
summary(m_BW_bam_covid_2nd_trimester)
gam.check(m_BW_bam_covid_2nd_trimester) 
  
  beta <- coef(m_BW_bam_covid_2nd_trimester)
  Vb <- vcov(m_BW_bam_covid_2nd_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1184860
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci.2ndtrim <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  round(head(17), 2)
  my.ci.covid_2nd_trim <- format(round(my.ci.2ndtrim[17, c(1:4)], digits=2), nsmall=2)
  my.ci.covid_2nd_trim
```


### Third-trimester exposure to COVID
```{r}
m_BW_bam_covid_3rd_trimester <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_third_trimester, data=bevn_eco_in7) 
summary(m_BW_bam_covid_3rd_trimester)
gam.check(m_BW_bam_covid_3rd_trimester) 
  
  beta <- coef(m_BW_bam_covid_3rd_trimester)
  Vb <- vcov(m_BW_bam_covid_3rd_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 585295
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci.3rdtrim <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  round(head(my.ci,17), 2)
  my.ci.covid_3rd_trim <- format(round(my.ci.3rdtrim[17, c(1:4)], digits=2), nsmall=2)
  my.ci.covid_1st_trim
  my.ci.covid_2nd_trim
  my.ci.covid_3rd_trim
```


## Effect of being exposed to COVID during two trimesters (1+3) vs  one trimester only.
Data: only COVID cases (so 2020-21). Not month and time variables-
```{r}
# m_BW_bam_covid_two_trimesters <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + COVID_two_trimesters, data=bevn_eco_in7_COVID_exp_during_pregnancy) 
# summary(m_BW_bam_covid_two_trimesters)
# gam.check(m_BW_bam_covid_two_trimesters) 
#  
#   beta <- coef(m_BW_bam_covid_two_trimesters)
#   Vb <- vcov(m_BW_bam_covid_two_trimesters, unconditional = TRUE)
#   se <- sqrt(diag(Vb))
#   n <- 127888
#   d <- (abs(beta)/(sqrt(n)*se))
#   my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
#   round(head(my.ci,15), 2)
```

# Stillbirth

## Effect of being exposed during each specific trimester

### First-trimester exposure to COVID
```{r}
m_SB_bam_covid_1st_trimester <- bam(stillbirth ~ s(GA_weeks) +  s(mat_age) +  s(birth_Y_M_num) +s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)  +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_trimester, family="binomial", data=bevn_eco_in6) 
summary(m_SB_bam_covid_1st_trimester)
gam.check(m_SB_bam_covid_1st_trimester) 

  OR <- exp(coef(m_SB_bam_covid_1st_trimester))
  beta <- coef(m_SB_bam_covid_1st_trimester)
  Vb <- vcov(m_SB_bam_covid_1st_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my_ci_SB_1st_trim <- data.frame(cbind(OR, lci, uci, d))
  round(head(my_ci_SB_1st_trim, 14), 2)
  my_ci_SB_1st_trim_covid <- format(round(my_ci_SB_1st_trim[14, c(1:4)], digits=2), nsmall=2)
  my_ci_SB_1st_trim_covid
```

### Second-trimester exposure to COVID
```{r}
m_SB_bam_covid_2nd_trimester <- bam(stillbirth ~ s(GA_weeks) +  s(mat_age) +  s(birth_Y_M_num) +s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)  +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_second_trimester, family="binomial", data=bevn_eco_in6) 
summary(m_SB_bam_covid_2nd_trimester)
gam.check(m_SB_bam_covid_2nd_trimester) 
 
  OR <- exp(coef(m_SB_bam_covid_2nd_trimester))
  beta <- coef(m_SB_bam_covid_2nd_trimester)
  Vb <- vcov(m_SB_bam_covid_2nd_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my_ci_SB_2nd_trim <- data.frame(cbind(OR, lci, uci, d))
  round(head(my_ci_SB_2nd_trim, 14), 2)
  my_ci_SB_2nd_trim_covid <- format(round(my_ci_SB_2nd_trim[14, c(1:4)], digits=2), nsmall=2)
  my_ci_SB_2nd_trim_covid
```

### Third-trimester exposure to COVID
```{r}
m_SB_bam_covid_3rd_trimester <- bam(stillbirth ~ s(GA_weeks) +  s(mat_age) +  s(birth_Y_M_num) +s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)  +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_third_trimester, family="binomial", data=bevn_eco_in6) 
summary(m_SB_bam_covid_3rd_trimester)
gam.check(m_SB_bam_covid_3rd_trimester) 
 
  OR <- exp(coef(m_SB_bam_covid_3rd_trimester))
  beta <- coef(m_SB_bam_covid_3rd_trimester)
  Vb <- vcov(m_SB_bam_covid_3rd_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my_ci_SB_3rd_trim <- data.frame(cbind(OR, lci, uci, d))
  round(head(my_ci_SB_3rd_trim, 14), 2)
  my_ci_SB_3rd_trim_covid <- format(round(my_ci_SB_3rd_trim[14, c(1:4)], digits=2), nsmall=2)
  
 my_ci_SB_1st_trim_covid  
 my_ci_SB_2nd_trim_covid
 my_ci_SB_3rd_trim_covid
```


## Effect of being exposed to COVID during two trimesters (1+3) vs  one trimester only.
Data: only COVID cases (so 2020-21). Not month and time variables-
```{r}
m_SB_bam_covid_two_trimesters <- bam(stillbirth ~ s(GA_weeks) +  s(mean_Alt_mean2)+  mat_age + mean_ssep2 +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + COVID_two_trimesters, family="binomial", data=bevn_eco_in6_COVID_exp_during_pregnancy) 
summary(m_SB_bam_covid_two_trimesters)
gam.check(m_SB_bam_covid_two_trimesters) 
  
  OR <- exp(coef(m_SB_bam_covid_two_trimesters))
  beta <- coef(m_SB_bam_covid_two_trimesters)
  Vb <- vcov(m_SB_bam_covid_two_trimesters, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 14), 2)
```

# Pretermbirth
## Effect of being exposed during each specific trimester

### First-trimester exposure to COVID
```{r}
m_PTB_bam_covid_1st_trimester <- bam(PTB ~ s(BW) +  s(mat_age) + s(birth_Y_M_num)  + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2) + parity_cat +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_trimester, family="binomial", data=bevn_eco_in7) 
summary(m_PTB_bam_covid_1st_trimester)
gam.check(m_PTB_bam_covid_1st_trimester)

  OR <- exp(coef(m_PTB_bam_covid_1st_trimester))
  beta <- coef(m_PTB_bam_covid_1st_trimester)
  Vb <- vcov(m_PTB_bam_covid_1st_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my_ci_PTB_1st_trim <- data.frame(cbind(OR, lci, uci, d))
  round(head(my_ci_PTB_1st_trim, 17), 2)
  my_ci_PTB_1st_trim_covid <- format(round(my_ci_PTB_1st_trim[17, c(1:4)], digits=2), nsmall=2)
```

### Second-trimester exposure to COVID
```{r}
m_PTB_bam_covid_2nd_trimester <- bam(PTB ~ s(BW) +  s(mat_age) + s(birth_Y_M_num)  + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2) + parity_cat +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_second_trimester, family="binomial", data=bevn_eco_in7) 
summary(m_PTB_bam_covid_2nd_trimester)
gam.check(m_PTB_bam_covid_2nd_trimester)    
  OR <- exp(coef(m_PTB_bam_covid_2nd_trimester))
  beta <- coef(m_PTB_bam_covid_2nd_trimester)
  Vb <- vcov(m_PTB_bam_covid_2nd_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my_ci_PTB_2nd_trim <- data.frame(cbind(OR, lci, uci, d))
  round(head(my_ci_PTB_2nd_trim, 17), 2)
  my_ci_PTB_2nd_trim_covid <- format(round(my_ci_PTB_2nd_trim[17, c(1:4)], digits=2), nsmall=2)
```

### Third-trimester exposure to COVID
```{r}
m_PTB_bam_covid_3rd_trimester <- bam(PTB ~ s(BW) +  s(mat_age) + s(birth_Y_M_num)  + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2) + parity_cat +  sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_third_trimester, family="binomial", data=bevn_eco_in7) 

summary(m_PTB_bam_covid_3rd_trimester)
gam.check(m_PTB_bam_covid_3rd_trimester)    
  OR <- exp(coef(m_PTB_bam_covid_3rd_trimester))
  beta <- coef(m_PTB_bam_covid_3rd_trimester)
  Vb <- vcov(m_PTB_bam_covid_3rd_trimester, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my_ci_PTB_3rd_trim <- data.frame(cbind(OR, lci, uci, d))
  round(head(my_ci_PTB_3rd_trim, 17), 2)
  my_ci_PTB_3rd_trim_covid <- format(round(my_ci_PTB_3rd_trim[17, c(1:4)], digits=2), nsmall=2)
  my_ci_PTB_1st_trim_covid
  my_ci_PTB_2nd_trim_covid
  my_ci_PTB_3rd_trim_covid
```
