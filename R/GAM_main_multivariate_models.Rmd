---
title: "Final multivariable GAMs. With the outcomes birthweight, preterm birth and stillbirth. Without adj. for Gest age"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Birthweight 

```{r}
# m_BW3 <- bam(BW ~ s(mat_age) + s(birth_Y_M_num, k=7)+  s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR_relativ_total + covid_hosp_relativ_total, data=bevn_eco_in7) 
# summary(m_BW3)
 
# Model used in paper:
 m_BW3 <- bam(BW ~ s(mat_age) +  s(month, bs="cc")+ birth_Y_M_num + mean_ssep2_by_10 + mean_Alt_mean2_by_100 + parity_cat + sex + Urban3 + Language + mother_nationality_cat2  +civil_status3+ HW + GR_relativ_by_pregn_month + covid_hosp_relativ_by_pregn_month, data=bevn_eco_in7)
summary(m_BW3)

  k.check(m_BW3)
cor(bevn_eco_in7$birth_Y_M_num, bevn_eco_in7$GR_relativ_by_pregn_month)

# extracting the plot information
plot_m_BW_main_mat_age <- GAM_plot_function_continuous(m_BW3, 1) # mat age
plot_m_BW_main_month <- GAM_plot_function_continuous(m_BW3, 2) #seasonality
```

## Graph maternal age variable X BW (not adj for GA)

```{r}
plot_BW_main_mat_age <- ggplot(data=plot_m_BW_main_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_main_mat_age
```


## Graph seasonality X birthweight (not adj for GA)

```{r}
plot_BW_main_month <- ggplot(data=plot_m_BW_main_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_main_month
```

## Graph time X birthweight

```{r}
# x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
#   select(birth_Y_M, birth_Y_M_num) %>%
#   distinct(birth_Y_M, .keep_all = TRUE) %>%
#   rename(x=birth_Y_M_num)
# 
# plot_data_BW <- plot_m_BW_main_time  %>%
#   mutate(x=round(x,0)) %>%
#   left_join(x_date) %>%
#   mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
# 
# lim1 <- as.POSIXct(ymd("2007-01-01"))
# lim2 <- as.POSIXct(ymd("2021-12-01"))
# 
# plot_BW_time <- ggplot(data=plot_data_BW)+
#   geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
#   geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
#   xlab("Timeline (years)")+
#   ylab("Birthweight (g)")+
#   coord_cartesian(ylim=c(3250,3550)) +
#   scale_colour_manual('BW',  #colour manual is for the line
#                       # labels=c("fully adjusted","95% CI","95% CI"),
#                       values =c("#9557DC"))+
#   scale_fill_manual('BW',                        # fill is for CI
#                     # labels=c("fully adjusted","95% CI","95% CI"),
#                     values =c("#9557DC"))+
#    scale_x_datetime( breaks = date_breaks("12 month"),
#                     labels = label_date_short(),
#                     limits =c(as.POSIXct("2007-01-01"), max(lim2)), #to force labelling from 2007 on the x axis
#                     expand = c(0,0)) +
#   theme_bw()+
#   theme(axis.text.y=element_text(color="black",size=size_axis),
#         axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
#         axis.title=element_text(size=size_axis_title),
#         legend.text=element_text(size=size_legend),
#         legend.title=element_text(size=size_legend_title),
#         legend.position="bottom",
#          legend.key.width = unit(1.5, "cm"),
#         legend.key.height = unit(0.5, "cm")) +
# theme(axis.title.x = axis.title.x.position)
# plot_BW_time
```

## Table summarizing the birthweight outcome model
### Categorical and smooth variables together
```{r}
beta <- coef(m_BW3)
Vb <- vcov(m_BW3, unconditional = TRUE)
se <- sqrt(diag(Vb))
n <- 1263853 #to check
d <- (abs(beta)/(sqrt(n)*se))
my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
tab_BW_bam <- format(round(head(my.ci,20), 2), nsmall=2)

tab_BW_bam['Variable'] <- c("Intercept", 
                            "Time (by month)", "SSEP (/10 points)",
                            "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                            "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)",
                            "Heatwave (ref: 0)",
                            "Great Recession (continuous)",
                            "COVID (continuous)")
tab_BW_bam['Category'] <- c(" ", 
                            " "," "," ",
                            "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", "1", "","")
tab_BW_bam<-tab_BW_bam[, c('Variable', "Category", "beta", "lci","uci", "d")]
tab_BW_bam <-tab_BW_bam %>%
  mutate(beta=as.character(beta),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))

pvalues_smooth_BW_main = summary(m_BW3)
pvalues_smooth_BW_main <- pvalues_smooth_BW_main$s.table[,4]
pvalues_smooth_BW_main <- format(pvalues_smooth_BW_main, scientific=FALSE)

pvalues_smooth_BW_main_df <- data.frame(pvalues_smooth_BW_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_BW_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(beta="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")

pvalues_smooth_BW_main_df$pvalue <-  format(round(pvalues_smooth_BW_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_BW_main_df <- pvalues_smooth_BW_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_BW_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_BW_main_df$pvalue1), 
                                             pvalues_smooth_BW_main_df$pvalue, pvalues_smooth_BW_main_df$pvalue1))
pvalues_smooth_BW_main_df <- pvalues_smooth_BW_main_df%>%
  rename("d"="pvalue1") %>%
  select(-one_of('pvalue')) 
rowinfo = c("Smooth variables", "p-value","", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_BW_main_df)

BW <- rbind(tab_BW_bam, ow)

BW_main_gt <- BW %>%
  gt()%>%
  tab_header(title=md(gt::html("**Table 2 : Association between birthweight and <br> neonatal, maternal and ecological factors from a GAM (model 1.1)**"))) %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
      cell_fill(color = "#E0E0E0")
    ),
    locations = cells_body(rows=c(2, 4, 8, 10,11,
                                  17,19,22)))%>%
  tab_style(
    style = list(
      cell_fill(color = "#F2F0F0")),
    locations = cells_body(rows=c(3, 5, 6, 7, 9, 12, 13,
                                  14,15,16,18,20,23))) %>%
  tab_options(table.width = pct(40), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 21)) %>%
  tab_source_note(source_note = "n=1,263,853")
BW_main_gt
```

### Without the intercept and without p values
```{r}
# check n: 1263853
beta <- coef(m_BW3)
Vb <- vcov(m_BW3, unconditional = TRUE)
se <- sqrt(diag(Vb))
n <- 1263853 #to check
d <- (abs(beta)/(sqrt(n)*se))
my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
tab_BW_bam <- format(round((my.ci[2:20,]), 2), nsmall=2)

tab_BW_bam['Variable'] <- c("Time (by month)", "SSEP (/10 points)",
                            "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                            "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)",
                            "Heatwave (ref: 0)",
                            "Great Recession (continuous)",
                            "COVID (continuous)")
tab_BW_bam['Category'] <- c(" "," "," ",
                            "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", "1", "","")
tab_BW_bam<-tab_BW_bam[, c('Variable', "Category", "beta", "lci","uci", "d")]
tab_BW_bam <-tab_BW_bam %>%
  mutate(beta=as.character(beta),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
 
pvalues_smooth_BW_main = summary(m_BW3)
pvalues_smooth_BW_main <- pvalues_smooth_BW_main$s.table[,4]
pvalues_smooth_BW_main <- format(pvalues_smooth_BW_main, scientific=FALSE)

pvalues_smooth_BW_main_df <- data.frame(pvalues_smooth_BW_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_BW_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(beta="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")

pvalues_smooth_BW_main_df$pvalue <-  format(round(pvalues_smooth_BW_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_BW_main_df <- pvalues_smooth_BW_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_BW_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_BW_main_df$pvalue1), 
                                             pvalues_smooth_BW_main_df$pvalue, pvalues_smooth_BW_main_df$pvalue1))
pvalues_smooth_BW_main_df <- pvalues_smooth_BW_main_df%>%
  rename("d"="pvalue1") %>%
  select(-one_of('pvalue')) 
rowinfo = c("Smooth variables", "p-value","", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_BW_main_df)

BW <- rbind(tab_BW_bam, ow)

BW_main_gt <- BW %>%
  gt()%>%
  # tab_header(title=md(gt::html("**Table 2 : Association between birthweight and <br> neonatal, maternal and ecological factors from a GAM (model 1.1)**"))) %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
      cell_fill(color = "#E0E0E0")
    ),
    locations = cells_body(rows=c(1, 3, 7,9,10,16,18,21)))%>%
  tab_style(
    style = list(
      cell_fill(color = "#F2F0F0")),
    locations = cells_body(rows=c(2,4,5,6,8,11:15,17,19,22))) %>%
  tab_options(table.width = pct(30), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 20)) %>%
  tab_source_note(source_note = "n=1,263,853")
BW_main_gt
```

### Without the intercept, with pvalues of all
```{r}
 m_BW3 <- bam(BW ~ s(mat_age) +  s(month, bs="cc")+ HW + GR_relativ_by_pregn_month + covid_hosp_relativ_by_pregn_month+birth_Y_M_num + mean_ssep2_by_10 + mean_Alt_mean2_by_100 + parity_cat + sex + Urban3 + Language + mother_nationality_cat2  +civil_status3, data=bevn_eco_in7)

# check n: 1263853
beta <- coef(m_BW3)
Vb <- vcov(m_BW3, unconditional = TRUE)
se <- sqrt(diag(Vb))
n <- 1263853 #to check
d <- (abs(beta)/(sqrt(n)*se))
my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
tab_BW_bam <- format(round((my.ci[2:20,]), 2), nsmall=2)

tab_BW_bam['Variable'] <- c("Heatwave (ref: 0)",
                            "Great Recession (continuous)",
                            "COVID (continuous)",
                            "Time (by month)", "SSEP (/10 points)",
                            "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                            "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)")
tab_BW_bam['Category'] <- c( "1", "",""," "," "," ",
                            "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single")
tab_BW_bam<-tab_BW_bam[, c('Variable', "Category", "beta", "lci","uci", "d")]
tab_BW_bam <-tab_BW_bam %>%
  mutate(beta=as.character(beta),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
 
pvalue_non_smooth_m_BW3 = summary(m_BW3)
pvalue_non_smooth_m_BW3 <- pvalue_non_smooth_m_BW3$p.table[2:20, "Pr(>|t|)"]
pvalue_non_smooth_m_BW3 <- format(pvalue_non_smooth_m_BW3, scientific=FALSE)
pvalues_non_smooth_BW_main_df <- data.frame(pvalue_non_smooth_m_BW3)%>%
  rename(pvalues_smooth_BW_main=pvalue_non_smooth_m_BW3)

pvalues_non_smooth_BW_main_df['Variable'] <- c("Heatwave (ref: 0)",
                            "Great Recession (continuous)",
                            "COVID (continuous)",
                            "Time (by month)", "SSEP (/10 points)",
                            "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                            "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)"
                            )
pvalues_non_smooth_BW_main_df['Category'] <- c("1", "","", " "," "," ",
                            "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single")
pvalues_non_smooth_BW_main_df <- pvalues_non_smooth_BW_main_df %>%
  rename(c(pvalue=(pvalues_smooth_BW_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue)

pvalues_non_smooth_BW_main_df$pvalue <-  format(round(pvalues_non_smooth_BW_main_df$pvalue, digits=2), nsmall=2)

pvalues_non_smooth_BW_main_df <- pvalues_non_smooth_BW_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_non_smooth_BW_main_df$pvalue1 <- (ifelse(is.na(pvalues_non_smooth_BW_main_df$pvalue1), 
                                             pvalues_non_smooth_BW_main_df$pvalue, pvalues_non_smooth_BW_main_df$pvalue1))
pvalues_non_smooth_BW_main_df1 <- pvalues_non_smooth_BW_main_df %>%
  select(-one_of('pvalue')) %>%
    rename("pvalue"="pvalue1") 

BW <- tab_BW_bam %>%
  full_join(pvalues_non_smooth_BW_main_df1)

# add smooth p values
pvalues_smooth_BW_main = summary(m_BW3)
pvalues_smooth_BW_main <- pvalues_smooth_BW_main$s.table[,4]
pvalues_smooth_BW_main <- format(pvalues_smooth_BW_main, scientific=FALSE)

pvalues_smooth_BW_main_df <- data.frame(pvalues_smooth_BW_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_BW_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(beta="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="") %>%
  add_column(d="")

pvalues_smooth_BW_main_df$pvalue <-  format(round(pvalues_smooth_BW_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_BW_main_df <- pvalues_smooth_BW_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_BW_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_BW_main_df$pvalue1), 
                                             pvalues_smooth_BW_main_df$pvalue, pvalues_smooth_BW_main_df$pvalue1))
pvalues_smooth_BW_main_df <- pvalues_smooth_BW_main_df%>%
  select(-one_of('pvalue')) %>%
  rename("pvalue"="pvalue1")
pvalues_smooth_BW_main_df<-pvalues_smooth_BW_main_df[, c('Variable', "Category", "beta", "lci","uci", "d", "pvalue")]

rowinfo = c("Smooth variables", " ","", "", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_BW_main_df)

BW_full <- rbind(BW, ow)

BW_main_gt <- BW_full %>%
  gt()%>%
  # tab_header(title=md(gt::html("**Table 2 : Association between birthweight and <br> neonatal, maternal and ecological factors from a GAM (model 1.1)**"))) %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_options(table.width = pct(30), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 20)) %>%
  tab_source_note(source_note = "n=1,263,853")
BW_main_gt

BW_estimates_main_gt <- BW_main_gt%>%
  gtsave(here("output/tables_for_paper/pvalue_added_in_the_tables", "BW_estimates_categ_and_smooth_main_gt_with_pvalue.html"))
BW_estimates_main_gt <- BW_main_gt%>%
  gtsave(here("output/tables_for_paper/pvalue_added_in_the_tables", "BW_estimates_categ_and_smooth_main_gt_with_pvalue.docx"))
```


# Stillbirth- simple model, without adjusting for GA

```{r}
# model used in the paper:
  m_SB_crises <- bam(stillbirth~ s(mat_age) + birth_Y_M_num+ s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100 + sex + Urban3 + Language + mother_nationality_cat1 + civil_status3 + HW + GR_relativ_by_pregn_month + covid_hosp_relativ_by_pregn_month, family="binomial", data=bevn_eco_in6)

plot_m_SB_main_mat_age <- GAM_plot_function_binary(m_SB_crises, 1)
plot_m_SB_main_month <- GAM_plot_function_binary(m_SB_crises, 2)
summary(m_SB_crises)
concurvity(m_SB_crises, full = TRUE)
```

## Graph maternal age X Stillbirth

```{r}
plot_SB_main_mat_age <- ggplot(data=plot_m_SB_main_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.01)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_main_mat_age
```

## Graph seasonality X Stillbirth

```{r}
plot_SB_main_month <- ggplot(data=plot_m_SB_main_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.01)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_main_month
```

## Graph time X Stillbirth

```{r}
# x_date <-   bevn_eco_in6 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
#   select(birth_Y_M, birth_Y_M_num) %>%
#   distinct(birth_Y_M, .keep_all = TRUE) %>%
#   rename(x=birth_Y_M_num)
# 
# plot_data_SB <- plot_m_SB_main_time %>%
#   mutate(x=round(x,0)) %>%
#   left_join(x_date) %>%
#   mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
# 
# plot_SB_time <- ggplot(data=plot_data_SB)+
#   geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
#   geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
#   xlab("Timeline (years)")+
#   ylab("Stillbirth probability")+
#   coord_cartesian(ylim=c(0.0005,0.008)) +
#    scale_x_datetime( breaks = date_breaks("12 month"), 
#                     labels = label_date_short(),
#                     limits =c(as.POSIXct("2007-01-01"), max(lim2)),
#                     expand = c(0,0)) +
#   theme_bw()+
#   theme(axis.text.y=element_text(color="black",size=size_axis),
#         axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
#         axis.title=element_text(size=size_axis_title),
#         legend.text=element_text(size=size_legend),
#         legend.title=element_text(size=size_legend_title),
#         legend.position="bottom") +
# theme(axis.title.x = axis.title.x.position)
# plot_SB_time
```

## Catgorical and smooth variables together
```{r}
  OR <- exp(coef(m_SB_crises))
  beta <- coef(m_SB_crises)
  Vb <- vcov(m_SB_crises , unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_SB_main <- format(round(head(my.ci,13), 2), nsmall=2)
  
  tab_SB_main <-tab_SB_main %>%
  mutate(OR=as.character(OR),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
  
tab_SB_main['Variable'] <- c("Intercept", 
                             "Time (by month)","SSEP (/10 points)",
                            "Altitude (/100m)",
                             "Sex (ref: male)", "Urban (ref: rural)",
 "Language region (ref: German)", " ", 
  "Maternal nationality (ref: Swiss)", 
 "Civil status (ref: married)",
   "Heatwave (ref: 0)", "Great Recession (continuous)","COVID (continuous)")

    tab_SB_main['Category'] <- c(" ", 
                                 " "," "," ",
                                 "Female", "Urban", "French", "Italian", "Not Swiss", "Single", "1", "","")
    tab_SB_main<-tab_SB_main[, c('Variable', "Category", "OR", "lci","uci", "d")]


pvalues_smooth_SB_main = summary(m_SB_crises)
pvalues_smooth_SB_main <- pvalues_smooth_SB_main$s.table[,4]
pvalues_smooth_SB_main <- format(pvalues_smooth_SB_main, scientific=FALSE)

pvalues_smooth_SB_main_df <- data.frame(pvalues_smooth_SB_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_SB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(OR="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")

pvalues_smooth_SB_main_df$pvalue <-  format(round(pvalues_smooth_SB_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_SB_main_df <- pvalues_smooth_SB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_SB_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_SB_main_df$pvalue1), 
                                             pvalues_smooth_SB_main_df$pvalue, pvalues_smooth_SB_main_df$pvalue1))
pvalues_smooth_SB_main_df <- pvalues_smooth_SB_main_df%>%
  rename("d"="pvalue1") %>%
  select(-one_of('pvalue')) 
rowinfo = c("Smooth variables", "p-value","", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_SB_main_df)

SB <- rbind(tab_SB_main, ow)

SB_main_gt <- SB %>%
  gt()%>%
  tab_header(title=md(gt::html("**Table 4 : Association between the risk of stillbirth and <br> neonatal, maternal and ecological factors from a GAM (model 3.1)**"))) %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
 tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 6, 9, 11, 13,15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 5, 7, 8, 10,12,16))) %>%
  tab_options(table.width = pct(35), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 14)) %>%
  tab_source_note(source_note = "n=1,270,114")
SB_main_gt
```

## Without the intercept
## Catgorical and smooth variables together
```{r}
  OR <- exp(coef(m_SB_crises))
  beta <- coef(m_SB_crises)
  Vb <- vcov(m_SB_crises , unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_SB_main <- format(round((my.ci[2:13,]), 2), nsmall=2)
  
  tab_SB_main <-tab_SB_main %>%
  mutate(OR=as.character(OR),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
  
tab_SB_main['Variable'] <- c("Time (by month)","SSEP (/10 points)",
                            "Altitude (/100m)",
                             "Sex (ref: male)", "Urban (ref: rural)",
 "Language region (ref: German)", " ", 
  "Maternal nationality (ref: Swiss)", 
 "Civil status (ref: married)",
   "Heatwave (ref: 0)", "Great Recession (continuous)","COVID (continuous)")

    tab_SB_main['Category'] <- c(" "," "," ",
                                 "Female", "Urban", "French", "Italian", "Not Swiss", "Single", "1", "","")
    tab_SB_main<-tab_SB_main[, c('Variable', "Category", "OR", "lci","uci", "d")]


pvalues_smooth_SB_main = summary(m_SB_crises)
pvalues_smooth_SB_main <- pvalues_smooth_SB_main$s.table[,4]
pvalues_smooth_SB_main <- format(pvalues_smooth_SB_main, scientific=FALSE)

pvalues_smooth_SB_main_df <- data.frame(pvalues_smooth_SB_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_SB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(OR="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")

pvalues_smooth_SB_main_df$pvalue <-  format(round(pvalues_smooth_SB_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_SB_main_df <- pvalues_smooth_SB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_SB_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_SB_main_df$pvalue1), 
                                             pvalues_smooth_SB_main_df$pvalue, pvalues_smooth_SB_main_df$pvalue1))
pvalues_smooth_SB_main_df <- pvalues_smooth_SB_main_df%>%
  rename("d"="pvalue1") %>%
  select(-one_of('pvalue')) 
rowinfo = c("Smooth variables", "p-value","", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_SB_main_df)

SB <- rbind(tab_SB_main, ow)

SB_main_gt <- SB %>%
  gt()%>%
  # tab_header(title=md(gt::html("**Table 4 : Association between the risk of stillbirth and <br> neonatal, maternal and ecological factors from a GAM (model 3.1)**"))) %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
 tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(1,3,5,8,10,12,15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(2,4,6,7,9,11,14))) %>%
  tab_options(table.width = pct(30), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 13)) %>%
  tab_source_note(source_note = "n=1,270,114")
SB_main_gt
```


### Without the intercept but with the pvalue
```{r}
  m_SB_crises <- bam(stillbirth~ s(mat_age) + s(month, bs="cc")+ HW + GR_relativ_by_pregn_month + covid_hosp_relativ_by_pregn_month+ birth_Y_M_num + mean_ssep2_by_10 + mean_Alt_mean2_by_100 + sex + Urban3 + Language + mother_nationality_cat1 + civil_status3, family="binomial", data=bevn_eco_in6)

  OR <- exp(coef(m_SB_crises))
  beta <- coef(m_SB_crises)
  Vb <- vcov(m_SB_crises , unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_SB_bam <- format(round((my.ci[2:13,]), 2), nsmall=2)
  
tab_SB_crises <-tab_SB_bam %>%
  mutate(OR=as.character(OR),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
 
tab_SB_crises['Variable'] <- c("Heatwave (ref: 0)", "Great Recession (continuous)",
                            "COVID (continuous)",
                            "Time (by month)","SSEP (/10 points)",
                            "Altitude (/100m)",
                             "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", 
                            "Civil status (ref: married)"
                            )

    tab_SB_crises['Category'] <- c("1", "","",
                                    " "," "," ",
                                 "Female",
                                 "Urban", "French", "Italian",
                                  "Not Swiss",
                            "Single")
    tab_SB_crises<-tab_SB_crises[, c('Variable', "Category", "OR", "lci","uci", "d")]


pvalue_non_smooth_m_SB3 = summary(m_SB_crises)
pvalue_non_smooth_m_SB3 <- pvalue_non_smooth_m_SB3$p.table[2:13, "Pr(>|z|)"]
pvalue_non_smooth_m_SB3 <- format(pvalue_non_smooth_m_SB3, scientific=FALSE)
pvalues_non_smooth_SB_main_df <- data.frame(pvalue_non_smooth_m_SB3)%>%
  rename(pvalues_smooth_SB_main=pvalue_non_smooth_m_SB3)

pvalues_non_smooth_SB_main_df['Variable'] <- c("Heatwave (ref: 0)",
                            "Great Recession (continuous)",
                            "COVID (continuous)",
                            "Time (by month)", "SSEP (/10 points)",
                            "Altitude (/100m)",
                            "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", 
                            "Civil status (ref: married)"
                            )
pvalues_non_smooth_SB_main_df['Category'] <- c( "1", "","",
                                                 " "," "," ",
                            "Female", "Urban", "French", "Italian", 
                            "Not Swiss", "Single")
pvalues_non_smooth_SB_main_df <- pvalues_non_smooth_SB_main_df %>%
  rename(c(pvalue=(pvalues_smooth_SB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue)

pvalues_non_smooth_SB_main_df$pvalue <-  format(round(pvalues_non_smooth_SB_main_df$pvalue, digits=2), nsmall=2)

pvalues_non_smooth_SB_main_df <- pvalues_non_smooth_SB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_non_smooth_SB_main_df$pvalue1 <- (ifelse(is.na(pvalues_non_smooth_SB_main_df$pvalue1), 
                                             pvalues_non_smooth_SB_main_df$pvalue, pvalues_non_smooth_SB_main_df$pvalue1))
pvalues_non_smooth_SB_main_df1 <- pvalues_non_smooth_SB_main_df %>%
  select(-one_of('pvalue')) %>%
    rename("pvalue"="pvalue1") 

SB <- tab_SB_crises %>%
  full_join(pvalues_non_smooth_SB_main_df1)  
    
# p values smooth variables
pvalues_smooth_SB_main = summary(m_SB_crises)
pvalues_smooth_SB_main <- pvalues_smooth_SB_main$s.table[,4]
pvalues_smooth_SB_main <- format(pvalues_smooth_SB_main, scientific=FALSE)

pvalues_smooth_SB_main_df <- data.frame(pvalues_smooth_SB_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_SB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(OR="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")%>%
  add_column(d="")


pvalues_smooth_SB_main_df$pvalue <-  format(round(pvalues_smooth_SB_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_SB_main_df <- pvalues_smooth_SB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_SB_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_SB_main_df$pvalue1), 
                                             pvalues_smooth_SB_main_df$pvalue, pvalues_smooth_SB_main_df$pvalue1))


pvalues_smooth_SB_main_df <- pvalues_smooth_SB_main_df%>%
   select(-one_of('pvalue')) %>%
  rename("pvalue"="pvalue1") 
pvalues_smooth_SB_main_df<-pvalues_smooth_SB_main_df[, c('Variable', "Category", "OR", "lci","uci", "d", "pvalue")]

rowinfo = c("Smooth variables", "","", "", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_SB_main_df)

SB_full <- rbind(SB, ow)

SB_main_gt <- SB_full %>%
  gt()%>%
 # tab_header(title=md(gt::html("**Table 4 : Association between the risk of stillbirth and <br> neonatal, maternal and ecological factors from a GAM (model 3.1)**"))) %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_options(table.width = pct(30), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 13)) %>%
  tab_source_note(source_note = "n=1,270,214")
SB_main_gt

SB_estimates_main_gt <- SB_main_gt%>%
  gtsave(here("output/tables_for_paper/pvalue_added_in_the_tables", "SB_estimates_categ_and_smooth_main_gt_with_pvalue.html"))
SB_estimates_main_gt <- SB_main_gt%>%
  gtsave(here("output/tables_for_paper/pvalue_added_in_the_tables", "SB_estimates_categ_and_smooth_main_gt_with_pvalue.docx"))
```


# Preterm birth
```{r echo=FALSE}
 #model used in the paper
     m_PTB3_crises <- bam(PTB ~s(mat_age) + birth_Y_M_num + s(month, bs="cc") + mean_ssep2_by_10 + mean_Alt_mean2_by_100+  parity_cat + sex +Urban3 + Language + mother_nationality_cat2 + civil_status3+  HW + GR_relativ_by_pregn_month  + covid_hosp_relativ_by_pregn_month, family="binomial", data=bevn_eco_in7)

# extracting the plot information
plot_m_PTB_main_mat_age <- GAM_plot_function_binary(m_PTB3_crises, 1)
plot_m_PTB_main_month <- GAM_plot_function_binary(m_PTB3_crises, 2)
```

## Graph maternal age X preterm birth

```{r}
plot_PTB_main_mat_age <- ggplot(data=plot_m_PTB_main_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.05,0.2)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_main_mat_age
```


## Graph seasonality X preterm birth 
```{r}
plot_PTB_main_seasonality <- ggplot(data=plot_m_PTB_main_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.05,0.2)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_main_seasonality
```


## Graph time variable X preterm birth

```{r}
# x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
#   select(birth_Y_M, birth_Y_M_num) %>%
#   distinct(birth_Y_M, .keep_all = TRUE) %>%
#   rename(x=birth_Y_M_num)
# 
# plot_data_PTB <- plot_m_PTB_main_time %>%
#   mutate(x=round(x,0)) %>%
#   left_join(x_date) %>%
#   mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
# lim1 <- as.POSIXct(ymd("2007-01-01"))
# lim2 <- as.POSIXct(ymd("2022-12-01"))
# 
# plot_PTB <- ggplot(data=plot_data_PTB)+
#   geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
#   geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
#   xlab("Timeline (years)")+
#   ylab("Preterm birth probability")+
#   coord_cartesian(ylim=c(0.005,0.1)) +
#   scale_x_datetime( breaks = date_breaks("12 month"), 
#                     labels = label_date_short(),
#                     limits =c(as.POSIXct("2007-01-01"), max(lim2)),
#                     expand = c(0,0)) +
#   theme_bw()+
#   theme(axis.text.y=element_text(color="black",size=size_axis),
#         axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
#         axis.title=element_text(size=size_axis_title),
#         legend.text=element_text(size=size_legend),
#         legend.title=element_text(size=size_legend_title),
#         legend.position="bottom") +
# theme(axis.title.x = axis.title.x.position)
# plot_PTB
```

## Table summarizing the preterm birth outcome model
### Categorical and smooth variables together
```{r}
  OR <- exp(coef(m_PTB3_crises))
  beta <- coef(m_PTB3_crises)
  Vb <- vcov(m_PTB3_crises , unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
tab_BW_bam <- format(round(head(my.ci,20), 2), nsmall=2)
  
  tab_PTB_crises <-tab_BW_bam %>%
  mutate(OR=as.character(OR),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
 
tab_PTB_crises['Variable'] <- c("Intercept", 
                             "Time (by month)","SSEP (/10 points)",
                            "Altitude (/100m)","Parity (ref: 1)", " ", " ", 
                             "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)",
                            "Heatwave (ref: 0)", "Great Recession (continuous)","COVID (continuous)")

    tab_PTB_crises['Category'] <- c(" ", 
                                 " "," "," ",
                                 "2", "3", ">3", "Female",
                                 "Urban", "French", "Italian",
                                  "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America",
                            "Single", "1", "","")
    tab_PTB_crises<-tab_PTB_crises[, c('Variable', "Category", "OR", "lci","uci", "d")]


pvalues_smooth_PTB_main = summary(m_PTB3_crises)
pvalues_smooth_PTB_main <- pvalues_smooth_PTB_main$s.table[,4]
pvalues_smooth_PTB_main <- format(pvalues_smooth_PTB_main, scientific=FALSE)

pvalues_smooth_PTB_main_df <- data.frame(pvalues_smooth_PTB_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_PTB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(OR="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")

pvalues_smooth_PTB_main_df$pvalue <-  format(round(pvalues_smooth_PTB_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_PTB_main_df <- pvalues_smooth_PTB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_PTB_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_PTB_main_df$pvalue1), 
                                             pvalues_smooth_PTB_main_df$pvalue, pvalues_smooth_PTB_main_df$pvalue1))
pvalues_smooth_PTB_main_df <- pvalues_smooth_PTB_main_df%>%
  rename("d"="pvalue1") %>%
  select(-one_of('pvalue')) 
rowinfo = c("Smooth variables", "p-value","", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_PTB_main_df)

PTB <- rbind(tab_PTB_crises, ow)

PTB_main_gt <- PTB %>%
  gt()%>%
  tab_header(title=md(gt::html("**Table 3 : Association between the risk of preterm birth and <br> neonatal, maternal and ecological factors from a GAM (model 2.1)**"))) %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 8, 10,11,
                                      17,19,23)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 5, 6, 7, 9, 12, 13,
                                      14,15,16,18,20,22))) %>%
  tab_options(table.width = pct(40), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 21)) %>%
  tab_source_note(source_note = "n=1,263,853")
PTB_main_gt
```

### Without the intercept
```{r}
  OR <- exp(coef(m_PTB3_crises))
  beta <- coef(m_PTB3_crises)
  Vb <- vcov(m_PTB3_crises , unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_PTB_bam <- format(round((my.ci[2:20,]), 2), nsmall=2)
  
  tab_PTB_crises <-tab_PTB_bam %>%
  mutate(OR=as.character(OR),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
 
tab_PTB_crises['Variable'] <- c("Time (by month)","SSEP (/10 points)",
                            "Altitude (/100m)","Parity (ref: 1)", " ", " ", 
                             "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)",
                            "Heatwave (ref: 0)", "Great Recession (continuous)",
                            "COVID (continuous)")

    tab_PTB_crises['Category'] <- c(" "," "," ",
                                 "2", "3", ">3", "Female",
                                 "Urban", "French", "Italian",
                                  "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America",
                            "Single", "1", "","")
    tab_PTB_crises<-tab_PTB_crises[, c('Variable', "Category", "OR", "lci","uci", "d")]


pvalues_smooth_PTB_main = summary(m_PTB3_crises)
pvalues_smooth_PTB_main <- pvalues_smooth_PTB_main$s.table[,4]
pvalues_smooth_PTB_main <- format(pvalues_smooth_PTB_main, scientific=FALSE)

pvalues_smooth_PTB_main_df <- data.frame(pvalues_smooth_PTB_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_PTB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(OR="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")

pvalues_smooth_PTB_main_df$pvalue <-  format(round(pvalues_smooth_PTB_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_PTB_main_df <- pvalues_smooth_PTB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_PTB_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_PTB_main_df$pvalue1), 
                                             pvalues_smooth_PTB_main_df$pvalue, pvalues_smooth_PTB_main_df$pvalue1))
pvalues_smooth_PTB_main_df <- pvalues_smooth_PTB_main_df%>%
  rename("d"="pvalue1") %>%
  select(-one_of('pvalue')) 
rowinfo = c("Smooth variables", "p-value","", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_PTB_main_df)

PTB <- rbind(tab_PTB_crises, ow)

PTB_main_gt <- PTB %>%
  gt()%>%
  # tab_header(title=md(gt::html("**Table 3 : Association between the risk of preterm birth and <br> neonatal, maternal and ecological factors from a GAM (model 2.1)**"))) %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(1, 3, 7, 9, 10, 16, 18, 21)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(2,4,5,6,8,11,12,
                                      13,14,15,17,19,22))) %>%
  tab_options(table.width = pct(30), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 20)) %>%
  tab_source_note(source_note = "n=1,263,853")
PTB_main_gt
```


### Without the intercept but with the pvalue
```{r}
  m_PTB3_crises <- bam(PTB ~s(mat_age)  + s(month, bs="cc")+HW + GR_relativ_by_pregn_month  + covid_hosp_relativ_by_pregn_month+ birth_Y_M_num + mean_ssep2_by_10 + mean_Alt_mean2_by_100+  parity_cat + sex +Urban3 + Language + mother_nationality_cat2 + civil_status3, family="binomial", data=bevn_eco_in7)

  OR <- exp(coef(m_PTB3_crises))
  beta <- coef(m_PTB3_crises)
  Vb <- vcov(m_PTB3_crises , unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_PTB_bam <- format(round((my.ci[2:20,]), 2), nsmall=2)
  
tab_PTB_crises <-tab_PTB_bam %>%
  mutate(OR=as.character(OR),
         lci=as.character(lci),
         uci=as.character(uci),
         d=as.character(d))
 
tab_PTB_crises['Variable'] <- c("Heatwave (ref: 0)", "Great Recession (continuous)",
                            "COVID (continuous)",
                            "Time (by month)","SSEP (/10 points)",
                            "Altitude (/100m)","Parity (ref: 1)", " ", " ", 
                             "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)"
                            )

    tab_PTB_crises['Category'] <- c("1", "","",
                                    " "," "," ",
                                 "2", "3", ">3", "Female",
                                 "Urban", "French", "Italian",
                                  "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America",
                            "Single")
    tab_PTB_crises<-tab_PTB_crises[, c('Variable', "Category", "OR", "lci","uci", "d")]


pvalue_non_smooth_m_PTB3 = summary(m_PTB3_crises)
pvalue_non_smooth_m_PTB3 <- pvalue_non_smooth_m_PTB3$p.table[2:20, "Pr(>|z|)"]
pvalue_non_smooth_m_PTB3 <- format(pvalue_non_smooth_m_PTB3, scientific=FALSE)
pvalues_non_smooth_PTB_main_df <- data.frame(pvalue_non_smooth_m_PTB3)%>%
  rename(pvalues_smooth_BW_main=pvalue_non_smooth_m_PTB3)

pvalues_non_smooth_PTB_main_df['Variable'] <- c("Heatwave (ref: 0)",
                            "Great Recession (continuous)",
                            "COVID (continuous)",
                            "Time (by month)", "SSEP (/10 points)",
                            "Altitude (/100m)",
                            "Parity (ref: 1)", " ", " ", 
                            "Sex (ref: male)", "Urban (ref: rural)",
                            "Language region (ref: German)", " ", 
                            "Maternal nationality (ref: Swiss)", " ", " ",
                            " ", " ",
                            "Civil status (ref: married)"
                            )
pvalues_non_smooth_PTB_main_df['Category'] <- c( "1", "","",
                                                 " "," "," ",
                            "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single")
pvalues_non_smooth_PTB_main_df <- pvalues_non_smooth_PTB_main_df %>%
  rename(c(pvalue=(pvalues_smooth_BW_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue)

pvalues_non_smooth_PTB_main_df$pvalue <-  format(round(pvalues_non_smooth_PTB_main_df$pvalue, digits=2), nsmall=2)

pvalues_non_smooth_PTB_main_df <- pvalues_non_smooth_PTB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_non_smooth_PTB_main_df$pvalue1 <- (ifelse(is.na(pvalues_non_smooth_PTB_main_df$pvalue1), 
                                             pvalues_non_smooth_PTB_main_df$pvalue, pvalues_non_smooth_PTB_main_df$pvalue1))
pvalues_non_smooth_PTB_main_df1 <- pvalues_non_smooth_PTB_main_df %>%
  select(-one_of('pvalue')) %>%
    rename("pvalue"="pvalue1") 

PTB <- tab_PTB_crises %>%
  full_join(pvalues_non_smooth_PTB_main_df1)  
    
# p values smooth variables
pvalues_smooth_PTB_main = summary(m_PTB3_crises)
pvalues_smooth_PTB_main <- pvalues_smooth_PTB_main$s.table[,4]
pvalues_smooth_PTB_main <- format(pvalues_smooth_PTB_main, scientific=FALSE)

pvalues_smooth_PTB_main_df <- data.frame(pvalues_smooth_PTB_main) %>%
  dplyr::mutate(Variable=c("Maternal age (years)", "Seasonality (month)")) %>%
  rename(c(pvalue=(pvalues_smooth_PTB_main)))%>%
  mutate(pvalue=as.numeric(pvalue)) %>%
  mutate(pvalue1=pvalue) %>%
  add_column(OR="")%>%
  add_column(Category="")%>%
  add_column(lci="") %>%
  add_column(uci="")%>%
  add_column(d="")


pvalues_smooth_PTB_main_df$pvalue <-  format(round(pvalues_smooth_PTB_main_df$pvalue, digits=2), nsmall=2)

pvalues_smooth_PTB_main_df <- pvalues_smooth_PTB_main_df %>%
  mutate(pvalue1=case_when((pvalue1<0.00001) ~ "<0.0001",
                           (pvalue1<0.001)~ "<0.001",
                           (pvalue1<0.01)~ "<0.01")) 

pvalues_smooth_PTB_main_df$pvalue1 <- (ifelse(is.na(pvalues_smooth_PTB_main_df$pvalue1), 
                                             pvalues_smooth_PTB_main_df$pvalue, pvalues_smooth_PTB_main_df$pvalue1))


pvalues_smooth_PTB_main_df <- pvalues_smooth_PTB_main_df%>%
   select(-one_of('pvalue')) %>%
  rename("pvalue"="pvalue1") 
pvalues_smooth_PTB_main_df<-pvalues_smooth_PTB_main_df[, c('Variable', "Category", "OR", "lci","uci", "d", "pvalue")]

rowinfo = c("Smooth variables", "","", "", "", "", "")
ow <- rbind(rowinfo,pvalues_smooth_PTB_main_df)

PTB_full <- rbind(PTB, ow)

PTB_main_gt <- PTB_full %>%
  gt()%>%
  # tab_header(title=md(gt::html("**Table 3 : Association between the risk of preterm birth and <br> neonatal, maternal and ecological factors from a GAM (model 2.1)**"))) %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_options(table.width = pct(30), data_row.padding = px(1),   table.font.size = 12,
              column_labels.font.weight = "bold",  row_group.font.weight  = "bold",
              heading.title.font.size = 14, heading.subtitle.font.size = 14,
              source_notes.font.size = 12) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = 20)) %>%
  tab_source_note(source_note = "n=1,263,853")
PTB_main_gt

PTB_estimates_main_gt <- PTB_main_gt%>%
  gtsave(here("output/tables_for_paper/pvalue_added_in_the_tables", "PTB_estimates_categ_and_smooth_main_gt_with_pvalue.html"))
PTB_estimates_main_gt <- PTB_main_gt%>%
  gtsave(here("output/tables_for_paper/pvalue_added_in_the_tables", "PTB_estimates_categ_and_smooth_main_gt_with_pvalue.docx"))
```