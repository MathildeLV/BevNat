---
title: "Gam model: birthweight"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---



# 2007-2020
## Using mat. nationality category 1

```{r}
m_BW_bam4 <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month) + s(mean_ssep2) + parity_cat + sex + Urban3 + mother_nationality_cat1 + Language, data=bevn_eco_in7)
summary(m_BW_bam4)
```

## Using mat. nationality category 2
### First model
```{r}
m_BW_bam5 <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month) + s(mean_ssep2) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7)
  summary(m_BW_bam5)
  plot(m_BW_bam5, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])
  plot(m_BW_bam5, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])
  plot(m_BW_bam5, select=3, ylim=c(3300, 3380),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1],  xlab  = "0 : 2007-01,  25: 2009-01,  50: 2011-02,  75: 2013-03,  100: 2015-04,  125: 2017-05,  150: 2019-06")
  plot(m_BW_bam5, select=4, ylim=c(3325, 3345),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])
  plot(m_BW_bam5, select=5, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])

  plot(m_BW_bam5, all.terms = TRUE,pages=1, shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])
#checking that residuals are not determined
  gam.check(m_BW_bam5)
  concurvity(m_BW_bam5, full=TRUE) 
```
 
 Interpretation: p-values of the GAM check are not significant: residuals are randomly distributed. But k-index is <1 for mat age and month

### Try with mat age k=12 and month k=10

```{r}
m_BW_bam5_1 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=13) + s(birth_Y_M_num) + s(month, k=11) + s(mean_ssep2) + parity_cat + sex + Urban3 + Language + mother_nationality_cat2, data=bevn_eco_in7)
  summary(m_BW_bam5_1)
  gam.check(m_BW_bam5_1) 
  concurvity(m_BW_bam5_1, full=TRUE) 
  #from the "worst" case, the values are not high (high would be >0.8, usually)
  plot(m_BW_bam5_1, select=3, ylim=c(-15, 20), shade = TRUE, shade.col = "lightblue")
```

### Chosen GAM model for birthweight: 
Lower k for mat age (6 basis functions means k=7) to avoid overfitting

```{r}
  m_BW_bam5_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(month) + s(mean_ssep2) + parity_cat + sex + Urban3 + Language + mother_nationality_cat2, data=bevn_eco_in7)  
  summary(m_BW_bam5_2)
  gam.check(m_BW_bam5_2) 
  
  plot(m_BW_bam5_2, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])
  plot(m_BW_bam5_2, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1])
  plot(m_BW_bam5_2, select=3, ylim=c(3300, 3380),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1]  ,  xlab  = "0 : 2007-01,      25: 2009-01,        50: 2011-02,       75: 2013-03,       100: 2015-04,       125: 2017-05,       150: 2019-06"
)
  plot(m_BW_bam5_2, select=4, ylim=c(3325, 3345),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1])
  plot(m_BW_bam5_2, select=5, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1])
  
  #getting the CI 95% (interpret only for the non-smooth parameters)
  beta <- coef(m_BW_bam5_2)
  Vb <- vcov(m_BW_bam5_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se))
  round(head(my.ci,14), 2)
  
  #comparing models with different k parameters
  AIC(m_BW_bam5, m_BW_bam5_1, m_BW_bam5_2)
```

## Using mat. nationality category 3

```{r}
   m_BW_bam6 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(month, k=11) + s(mean_ssep2) + parity_cat + sex + Urban3 + Language + mother_nationality_cat3, data=bevn_eco_in7)
  summary(m_BW_bam6)
```

Interpretation of m_BW_bam5_2 model :

Why choosing m_BW_bam5_2? It has the lowest AIC and also lower k value for maternal age, which seems more appropriate by looking at the graph.

- Non-smooth terms

Increasing parity increases birthweight, from 126,129g at second parity, 171,176g at third parity, to 195-204g for parities over 3.

Being born female decreases by -148, -146g compared to males.

Urbanicity has no effect on birthweight.

Language: Compared to babies born in German(+Romansh)-speaking Switzerland, being born in the French-speaking part decreases BW by -50,-46g, while being born in the Italian-speaking part decreases BW by -67,-59g.

Maternal nationality: compared to babies born from Swiss mothers, babies born from Asian mothers are lighter -22g, -14g. Babies born from other-nationalites mothers are heavier: 7, 16g for Africa, 31, 34g for other European countries, 55, 75g for Northern America, 41,86g for Oceania, and 42-53g for Southern/Central America.


- Smooth terms

GA: Obviously, birthweight increases with increasing gestational age, with a plateau at around 800g for babies between 20 and 25 gestational weeks, and another plateau at around 4000g for babies above 45 weeks.

Maternal age: birthweight increases non-linearly with maternal age: for younger mothers (<25yo) it increases almost linearly from 3280g to 3350g, then declines very slightly until around 3340g when the mother is 25-40yo. Older women have heavier babies, increasing from 3340g to around 3360g for women 40-50yo (keep in mind we have excluded a few mothers above 50 - improbable).

Time (month+year combined): globally, birthweight is decreasing between 2007 and 2019 from 3350 to 3330 which is a minor change, and then increases from 2019 to reach 3350g. There are some other minor variations throughtout the whole time but this doesnt seem very relevant: only 20g variation.

Seasonal/month: minor sinusoidal seasonal variation between 3330-3340g, with lower birthweight in March and August. These difference dont seem much relevant either (10g variation will probably not impact the baby's health).

Mean ssep: Birthweight increases by increasing ssep, linearly between ssep=25-45 approx (3250-3340g), and then there is some minor birthweight increase for higher ssep, until reaching a BW of around 3360g. Overall, a +100g increase is probably worht mentioning. 

# 2008-2010 

```{r}
m_BW_bam_2009 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(month) + s(mean_ssep2) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7_2008_10)
  summary(m_BW_bam_2009)
  concurvity(m_BW_bam_2009, full=TRUE) 
```
Problem with birth_Y_M_num and month variables: values >>0.8, they correlate too much.
Also, mean ssep can be used as a linear term

## Removing month variable and using mean ssep as linear term

```{r}
  m_BW_bam_2009_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7_2008_10)
  summary(m_BW_bam_2009_2)
   plot(m_BW_bam_2009_2, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_2009)[1])
  plot(m_BW_bam_2009_2, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_2009)[1])
  plot(m_BW_bam_2009_2, select=3, ylim=c(3310, 3360),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_2009_2)[1],  xlab  = "13 : 2008-01,  20: 2008-08,  30: 2009-06,  40: 2010-04,  50: 2011-02")

  gam.check(m_BW_bam_2009_2)
  concurvity(m_BW_bam_2009_2, full=TRUE) #values are now fine.
  
  #getting the CI 95% 
  beta2 <- coef(m_BW_bam_2009_2)
  Vb2 <- vcov(m_BW_bam_2009_2, unconditional = TRUE)
  se2 <- sqrt(diag(Vb2))
  my.ci2 <- data.frame(cbind(beta2, lci = beta2-1.96*se2, uci = beta2 + 1.96*se2))
  round(head(my.ci2,14), 2)
```

# 2017-2020
```{r}
m_BW_bam_covid <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(month) + s(mean_ssep2) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7_2017_20)
  summary(m_BW_bam_covid)
  gam.check(m_BW_bam_covid)
  concurvity(m_BW_bam_covid, full=TRUE)
```

Problem with birth_Y_M_num and month variables: values >>0.8, they correlate too much

## Removing month variable

```{r}
  m_BW_bam_covid_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(mean_ssep2) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7_2017_20)
  summary(m_BW_bam_covid)
  plot(m_BW_bam_covid_2, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_covid_2)[1])
  plot(m_BW_bam_covid_2, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_covid_2)[1])
  plot(m_BW_bam_covid_2, select=3, ylim=c(3310, 3360),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_covid_2)[1],xlab  = "120 : 2016-12                   130: 2017-10,                        140: 2018-08,                   150: 2019-06,                      160: 2020-04")
  plot(m_BW_bam_covid_2, select=4, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_covid_2)[1])
  gam.check(m_BW_bam_covid_2)
  concurvity(m_BW_bam_covid_2, full=TRUE) #values are now fine.
  
  #getting the CI 95% 
  beta3 <- coef(m_BW_bam_covid_2)
  Vb3 <- vcov(m_BW_bam_covid_2, unconditional = TRUE)
  se3 <- sqrt(diag(Vb3))
  my.ci3 <- data.frame(cbind(beta3, lci = beta3-1.96*se3, uci = beta3 + 1.96*se3))
  round(head(my.ci3,14), 2)
```
