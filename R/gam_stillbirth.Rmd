---
title: "Gam model: stillbirth"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

# 2007-2020
## First model
```{r}
m_SB_bam<-bam(stillbirth~s(GA_weeks)+ s(mat_age) + s(birth_Y_M_num) + s(month) +s(mean_ssep2) + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6)
  summary(m_SB_bam) #birth_Y_M_num has no effect
 
  #adding intercept
  plot(m_SB_bam, pages = 1, trans = plogis, shift = coef(m_SB_bam)[1])
```

## Second model (chosen)
Putting mean_ssep2 and birth_Y_M_num as linear terms, and lowering k value for maternal age

```{r}
m_SB_bam2 <- bam(stillbirth~s(GA_weeks)+ s(mat_age, k=7) + s(month) + birth_Y_M_num + mean_ssep2 + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6)
  summary(m_SB_bam2)
  
  plot(m_SB_bam2, trans = plogis, select=1, shift = coef(m_SB_bam2)[1], shade = TRUE, shade.col = "lightblue") #GA
  plot(m_SB_bam2, trans = plogis, select=2, ylim=c(0, 0.003), shift = coef(m_SB_bam2)[1], shade = TRUE, shade.col = "lightblue") #mat age
  plot(m_SB_bam2, trans = plogis, select=3, ylim=c(0.0005, 0.0015), shift = coef(m_SB_bam2)[1], shade = TRUE, shade.col = "lightblue") #month
  gam.check(m_SB_bam2) 
  concurvity(m_SB_bam2)
  
  #to calculate the OR of stillbirth
    #getting the CI 95% (interpret only for the non-smooth parameters)
  beta_sbexp <- exp(coef(m_SB_bam2))
  beta_sb <- coef(m_SB_bam2)
  Vb_sb <- vcov(m_SB_bam2, unconditional = TRUE)
  se_sb <- sqrt(diag(Vb_sb))
  lci <- exp(beta_sb-1.96*se_sb)
  uci <- exp(beta_sb+1.96*se_sb)
  my.ci_sb <- data.frame(cbind(beta_sbexp, lci, uci))
  round(head(my.ci_sb,12), 2)
```

## Adding birthweight
```{r}
   m_SB_bam3 = update(m_SB_bam2, . ~ . + s(BW))
   summary(m_SB_bam3)
  plot(m_SB_bam3, trans = plogis, select=4, ylim=c(0, 1), shift = coef(m_SB_bam3)[1], shade = TRUE, shade.col = "lightblue") #BW with whole CI
  plot(m_SB_bam3, trans = plogis, select=4, ylim=c(0, 0.15), shift = coef(m_SB_bam3)[1], shade = TRUE, shade.col = "lightblue") #BW
  
  gam.check(m_SB_bam3) 
  concurvity(m_SB_bam3)
```
There is too much correlation betwwen gestational age and birthweight (concurvity shows 0.88 which is to close to 1): it is not a good idea to include BW in the model.

Comparing models with or without Birthweight variable:

```{r}
AIC(m_SB_bam2, m_SB_bam3)
```


# 2008-2010
```{r}
m_SB_bam_2009<-bam(stillbirth~s(GA_weeks)+ s(mat_age, k=7) + s(birth_Y_M_num) + mean_ssep2 + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6_2008_10)
summary(m_SB_bam_2009)
```

## Birth_Y_M_num linear

```{r}
  m_SB_bam_2009_2 <- update(m_SB_bam_2009, . ~ . + birth_Y_M_num -  s(birth_Y_M_num))
  summary(m_SB_bam_2009_2)
   plot(m_SB_bam_2009_2, trans = plogis, select=1, ylim=c(0, 1) ,shift = coef(m_SB_bam_2009_2)[1], shade = TRUE, shade.col = "lightblue") #GA
  plot(m_SB_bam_2009_2, trans = plogis, select=2, ylim=c(0, 0.004), shift = coef(m_SB_bam_2009_2)[1], shade = TRUE, shade.col = "lightblue") #mat age
  
  OR <- exp(coef(m_SB_bam_2009_2))
  beta <- coef(m_SB_bam_2009_2)
  Vb <- vcov(m_SB_bam_2009_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  my.ci <- data.frame(cbind(OR, lci, uci))
  round(head(my.ci, 12), 2)
  
  gam.check(m_SB_bam_2009_2)
  concurvity(m_SB_bam_2009_2)
```

# 2017-2020
##First model: time and maternal age as smooth variables
```{r}
m_SB_bam_covid<-bam(stillbirth~s(GA_weeks)+ s(mat_age, k=7) + s(birth_Y_M_num) +  mean_ssep2 + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6_2017_20)
summary(m_SB_bam_covid)
 plot(m_SB_bam_covid, trans = plogis, select=1, ylim=c(0, 1) ,shift = coef(m_SB_bam_covid)[1], shade = TRUE, shade.col = "lightblue") #GA

```
Maternal age and birth_Y_M_num variables have edf values very close to one: we can put them as linear terms instead of smoothed variables.

## Second model: time and maternal age as linear variables

```{r}
  m_SB_bam_covid_2 <- update(m_SB_bam_covid, . ~ . + birth_Y_M_num -  s(birth_Y_M_num) + mat_age - s(mat_age, k=7))
summary(m_SB_bam_covid_2)
 plot(m_SB_bam_covid_2, trans = plogis, select=1, ylim=c(0, 1) ,shift = coef(m_SB_bam_covid_2)[1], shade = TRUE, shade.col = "lightblue") #GA
 
  OR <- exp(coef(m_SB_bam_covid_2))
  beta <- coef(m_SB_bam_covid_2)
  Vb <- vcov(m_SB_bam_covid_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  my.ci <- data.frame(cbind(OR, lci, uci))
  round(head(my.ci, 13), 2)
  
 gam.check(m_SB_bam_covid_2)
 concurvity(m_SB_bam_covid_2)
```