---
title: "Gam model: stillbirth"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

# Birthweight

## 2007-2020

```{r}
m_BW_bam5_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(month) + s(mean_ssep2) + parity_cat + sex + Urban3 + Language + mother_nationality_cat2, data=bevn_eco_in7)  
  summary(m_BW_bam5_2)
  gam.check(m_BW_bam5_2) 
  
  plot(m_BW_bam5_2, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5)[1])
  plot(m_BW_bam5_2, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1])
  plot(m_BW_bam5_2, select=3, ylim=c(3300, 3380),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1]  ,  xlab  = "0 : 2007-01,      25: 2009-01,        50: 2011-02,       75: 2013-03,       100: 2015-04,       125: 2017-05,       150: 2019-06"
)
  plot(m_BW_bam5_2, select=4, ylim=c(3325, 3345),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1])
  plot(m_BW_bam5_2, select=5, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",  shift = coef(m_BW_bam5_2)[1])
```

Adjusting for the effect of the huge dataset (n=1,099,368)

Cohen's d formula:

$d=\frac{beta}{SD}$ and $SD=\sqrt{n}*se$

$d=\frac{beta}{\sqrt{n}*se}$

-   beta: estimate
-   se: standard error
-   n: population/observation size
-   SD: standard deviation

```{r}
#getting the CI 95% and d (interpret only for the non-smooth parameters)
  beta <- coef(m_BW_bam5_2)
  Vb <- vcov(m_BW_bam5_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1099328
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  round(head(my.ci,14), 2)
```

Interpretation of m_BW_bam5_2 model :

Why choosing m_BW_bam5_2? It has the lowest AIC and also lower k value for maternal age, which seems more appropriate by looking at the graph.

-   Non-smooth terms

Increasing parity increases birthweight compared to first births: from (126g, 129g) at second parity, (171g, 176g) at third parity, to (195g, 204g) for parities over 3.

Being born female decreases by (-148g, -146g) compared to males.

Urbanicity has no effect on birthweight.

Language: Compared to babies born in German(+Romansh)-speaking Switzerland, being born in the French-speaking part decreases BW by (-50g,-46g), while being born in the Italian-speaking part decreases BW by (-67g,-59g).

Maternal nationality: compared to babies born from Swiss mothers, babies born from Asian mothers are lighter (-22g, -14g). Babies born from other-nationalities mothers are heavier: (7g, 16g) for Africa, (31g, 34g) for other European countries, (55g, 75g) for Northern America, (42g, 86g) for Oceania, and (42g-53g) for Southern/Central America.

-   Smooth terms

GA: Obviously, birthweight increases with increasing gestational age, with a plateau at around 800g for babies between 20 and 25 gestational weeks, and another plateau at around 4000g for babies above 45 weeks.

Maternal age: birthweight increases non-linearly with maternal age: for younger mothers (\<25yo) it increases almost linearly from 3280g to 3350g, then declines very slightly until around 3340g when the mother is 25-40yo. Older women have heavier babies, increasing from 3340g to around 3360g for women 40-50yo (keep in mind we have excluded a few mothers above 50 - improbable).

Time (month+year combined): globally, birthweight is decreasing between 2007 and 2019 from 3350 to 3330 which is a minor change, and then increases from 2019 to reach 3350g. There are some other minor variations throughtout the whole time but this doesnt seem very relevant: only 20g variation.

Seasonal/month: minor sinusoidal seasonal variation between 3330-3340g, with lower birthweight in March and August. These difference dont seem much relevant either (10g variation will probably not impact the baby's health).

Mean ssep: Birthweight increases by increasing ssep, linearly between ssep=25-45 approx (3250-3340g), and then there is some minor birthweight increase for higher ssep, until reaching a BW of around 3360g. Overall, a +100g increase is probably worht mentioning.

## 2008-2010

Because birth_Y\_M_num and month variables correlated too much, moth variable was not kept in the model

```{r}
  m_BW_bam_2009_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age, k=7) + s(birth_Y_M_num) + s(mean_ssep2) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7_2008_10)
  summary(m_BW_bam_2009_2)
  plot(m_BW_bam_2009_2, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_2009_2)[1])
  plot(m_BW_bam_2009_2, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_2009_2)[1])
  plot(m_BW_bam_2009_2, select=3, ylim=c(3310, 3360),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_2009_2)[1],  xlab  = "13 : 2008-01,  20: 2008-08,  30: 2009-06,  40: 2010-04,  50: 2011-02")
    plot(m_BW_bam_2009_2, select=4, ylim=c(3300, 3400),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_2009_2)[1])

  gam.check(m_BW_bam_2009_2)
  concurvity(m_BW_bam_2009_2, full=TRUE) #values are now fine.
  
  # Summary of estimates, CI95% and Cohen's d
  beta <- coef(m_BW_bam_2009_2)
  Vb <- vcov(m_BW_bam_2009_2, unconditional = TRUE)
  se <- sqrt(diag(Vb2))
  n <- 219790
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci2 <- data.frame(cbind(beta2, lci = beta2-1.96*se2, uci = beta2 + 1.96*se2, d))
  round(head(my.ci2,14), 2)  
```

## 2017-2020

We also did not use the month variable because of correlation between month and time (birth_Y\_M_num) variables.

```{r}
  m_BW_bam_covid_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(mean_ssep2) + parity_cat + sex + Urban3  + Language + mother_nationality_cat2, data=bevn_eco_in7_2017_20)
  summary(m_BW_bam_covid)
  plot(m_BW_bam_covid_2, select=1, ylim=c(0, 4000),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_covid_2)[1])
  plot(m_BW_bam_covid_2, select=2, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue",shift = coef(m_BW_bam_covid_2)[1])
  plot(m_BW_bam_covid_2, select=3, ylim=c(3310, 3360),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_covid_2)[1],xlab  = "120 : 2016-12,  130: 2017-10,  140: 2018-08,  150: 2019-06,  160: 2020-04")
  plot(m_BW_bam_covid_2, select=4, ylim=c(3200, 3400),shade = TRUE, shade.col = "lightblue", shift = coef(m_BW_bam_covid_2)[1])
  gam.check(m_BW_bam_covid_2)
  concurvity(m_BW_bam_covid_2, full=TRUE) #values are now fine.
  
  # Summary of estimates, CI95% and Cohen's d
  beta3 <- coef(m_BW_bam_covid_2)
  Vb3 <- vcov(m_BW_bam_covid_2, unconditional = TRUE)
  se3 <- sqrt(diag(Vb3))
  n <- 332752
  my.ci3 <- data.frame(cbind(beta3, lci = beta3-1.96*se3, uci = beta3 + 1.96*se3, d))
  round(head(my.ci3,14), 2)
```

# Stillbirth

## 2007-2020

```{r}
m_SB_bam2 <- bam(stillbirth~s(GA_weeks)+ s(mat_age, k=7) + s(month) + birth_Y_M_num + mean_ssep2 + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6)
  summary(m_SB_bam2)
  
  plot(m_SB_bam2, trans = plogis, select=1, shift = coef(m_SB_bam2)[1], shade = TRUE, shade.col = "lightblue") #GA
  plot(m_SB_bam2, trans = plogis, select=2, ylim=c(0, 0.003), shift = coef(m_SB_bam2)[1], shade = TRUE, shade.col = "lightblue") #mat age
  plot(m_SB_bam2, trans = plogis, select=3, ylim=c(0.0005, 0.0015), shift = coef(m_SB_bam2)[1], shade = TRUE, shade.col = "lightblue") #month
  gam.check(m_SB_bam2) 
  concurvity(m_SB_bam2)
```

Calculation of Cohen's d for OR:

$d= \log(OR) * \frac{\sqrt{3}}{\pi}$

$d = \frac{log(OR)}{1.81}$

```{r}
#table to show OR, confidence interval and Cohen's d
  OR <- exp(coef(m_SB_bam2))
  beta <- coef(m_SB_bam2)
  Vb <- vcov(m_SB_bam2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 12), 2)
```
Time variables (birth_Y_M_num) and mean ssep variable were put as linear terms, because the model including them as smoothed terms showed that the relationship between these and stillbirth was linear.

#Adding BW --> discussing this.

```{r}
 m_SB_bam3 = update(m_SB_bam2, . ~ . + s(BW))
plot(m_SB_bam3, trans = plogis, select=4, ylim=c(0, 1), shift = coef(m_SB_bam3)[1], shade = TRUE, shade.col = "lightblue") #BW with whole CI
  plot(m_SB_bam3, trans = plogis, select=4, ylim=c(0, 0.15), shift = coef(m_SB_bam3)[1], shade = TRUE, shade.col = "lightblue") #BW
  concurvity(m_SB_bam3)
```

When we add birthweight, there is too much correlation betwwen gestational age and birthweight (concurvity shows 0.88 which is to close to 1): it is not a good idea to include BW in the model. But we can have a look at the smoothed curve for stillbirth depending on birthweight: it has a clear U shaped, with high stillbirth risk (2-11%) for very low birthweight babies (<2kg), and moderately high stillbirth risk (5-8%) for very high birthweight babies (>8kg).

## 2008-2010

```{r}
m_SB_bam_2009_2<-bam(stillbirth~s(GA_weeks)+ s(mat_age, k=7) + birth_Y_M_num + mean_ssep2 + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6_2008_10)
summary(m_SB_bam_2009_2)
   plot(m_SB_bam_2009_2, trans = plogis, select=1, ylim=c(0, 0.9) ,shift = coef(m_SB_bam_2009_2)[1], shade = TRUE, shade.col = "lightblue") #GA
  plot(m_SB_bam_2009_2, trans = plogis, select=2, ylim=c(0, 0.005), shift = coef(m_SB_bam_2009_2)[1], shade = TRUE, shade.col = "lightblue") #mat age
  gam.check(m_SB_bam_2009_2)
  concurvity(m_SB_bam_2009_2)
  
  OR <- exp(coef(m_SB_bam_2009_2))
  beta <- coef(m_SB_bam_2009_2)
  Vb <- vcov(m_SB_bam_2009_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 12), 2)
```

As for the previous model (including all timing 2007-2020), we kept time(birth_Y_M_num) and mean_ssep2 as linear terms.

## 2017-2020

```{r}
m_SB_bam_covid_2 <-bam(stillbirth~s(GA_weeks)+ mat_age + birth_Y_M_num +  mean_ssep2 + Urban3 + Language + mother_nationality_cat2,family="binomial", data=bevn_eco_in6_2017_20)
summary(m_SB_bam_covid_2)
 plot(m_SB_bam_covid_2, trans = plogis, select=1, ylim=c(0, 1) ,shift = coef(m_SB_bam_covid_2)[1], shade = TRUE, shade.col = "lightblue") #GA
 
  OR <- exp(coef(m_SB_bam_covid_2))
  beta <- coef(m_SB_bam_covid_2)
  Vb <- vcov(m_SB_bam_covid_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 13), 2)
  
 gam.check(m_SB_bam_covid_2)
 concurvity(m_SB_bam_2009_2)
```

Why we chose this model: Maternal age had edf values very close to one: we put it as a linear term instead of smoothed variable. As for the previous model (including all timing 2007-2020), we kept time (birth_Y_M_num) and mean_ssep2 variables as linear terms.

# Gestational age
## Continuous gestational age in days
### 2007-2020
### 2008-2010
### 2017-2020

# Pre-term birth: yes/no
### 2007-2020
### 2008-2010
### 2017-2020