---
title: "GAM_all_variables_different_outcomes"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

How did neonatal health evolve through time (2007-2020)?

Particularly, did it change during two important crisis: the 2009 economic crisis and the current COVID-19 pandemic?

We focus on the evolution of birthweight and gestational age, and on the rates of stillbirth, preterm birth, lowbirth weight and macrosomia babies.

COVID data will be included soon: hospital cases, mortality.
Temperature will also maybe be included.

# Data and Methods
## Data
We used data from the Federal Office of Statistics: Bevnat. It covers:

- All births that occurred in Switzerland

- Between 1987 and 2021 

## Variables

### Swiss-SEP
Average Swiss neighbourhood index of socioeconomic position (Swiss-SEP 2.0). Swiss-SEP 2.0 indicates the average socioeconomic situation in a municipality. It was developed by the Institute for Social and Preventive Medicine at the University of Bern.

## Exclusions steps
- As gestational age was only recorded systematically from 2007, we analysed data from this year only
- Steps of exclusions: see the ppt

Definitions:

- Preterm birth babies : <37 weeks

- Low birthweight babies : <2500g

- Macrosomia babies: >= 4000g

- "normal" birthweight babies: )2500-4000)

We work with two different datasets:

- one that includes stillbirth cases to investigate stillbirth outcome: bevn_eco_in6.

- one that excludes stillbirth cases to investigate birthweight/gestational age/ preterm birth/ low birth weight/ macrosomia outcomes : bevn_eco_in7.


## Characteristics at inclusion and in two other datasets used
- see tables in html.

## Methods

We built different GAM models, investigating the following outcomes:

- birthweight as a continuous variable

- stillbirth : binary yes/no variable

- gestational age: as a continuous variable, in days

- preterm birth: binary yes/no variable.

- low birthweight: binary yes/no variable, comparing LBW babies vs the rest

- low birthweight: binary yes/no variable, comparing LBW babies vs "normal" birthweight babies

- macrosomia: binary yes/no variable, comparing macrosomia babies vs "normal" birthweight babies


In the models the variable "birth_Y\_M_num" is used to account for time: it is numerical monthly time, with 1= January 2007 and 168=December 2020.

# Birthweight

We chose this model based on lower AIC and also lower k value for maternal age, which seems more appropriate when looking at the graph.

```{r}
m_BW_bam5_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, data=bevn_eco_in7) 

  summary(m_BW_bam5_2)
  gam.check(m_BW_bam5_2) 
  
# extracting the plot information
plot_m_BW_GA <- GAM_plot_function_continuous(m_BW_bam5_2, 1) # GA
plot_m_BW_mat_age <- GAM_plot_function_continuous(m_BW_bam5_2, 2) # mat age
plot_m_BW_time <- GAM_plot_function_continuous(m_BW_bam5_2, 3) #time
plot_m_BW_month <- GAM_plot_function_continuous(m_BW_bam5_2, 4) # seasonality
plot_m_BW_ssep <- GAM_plot_function_continuous(m_BW_bam5_2, 5) # ssep
plot_m_BW_altitude <- GAM_plot_function_continuous(m_BW_bam5_2, 6) # altitude
```

## Graph Gestational age X birthweight
```{r}
plot_BW_GA <- ggplot(data=plot_m_BW_GA)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Gestational age (weeks)")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5)) +
   scale_y_continuous(breaks=seq(0,5000,by=500))
plot_BW_GA
```

## Graph maternal age variable X BW
```{r}
plot_BW_mat_age <- ggplot(data=plot_m_BW_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Maternal age (years)")+
  ylab("Birthweight (g)")+
  scale_colour_manual('age', values =c("#9557DC"))+
  scale_fill_manual('age', values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5)) +
  scale_y_continuous(breaks=seq(0,4000,by=20))
plot_BW_mat_age
```

## Graph time X birthweight
```{r}
x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_BW <- plot_m_BW_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_BW_time <- ggplot(data=plot_data_BW)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Birthweight (g)")+
  scale_colour_manual('BW',  #colour manual is for the line
                      # labels=c("fully adjusted","95% CI","95% CI"),
                      values =c("#9557DC"))+
  scale_fill_manual('BW',                        # fill is for CI
                    # labels=c("fully adjusted","95% CI","95% CI"),  
                    values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")
plot_BW_time
```

## Graph seasonality X birthweight
```{r}
plot_BW_month <- ggplot(data=plot_m_BW_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Month")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1)) +
  scale_y_continuous(breaks=seq(0,4000,by=5))
plot_BW_month
```

## Graph SSEP X birthweight
```{r}
plot_BW_ssep <- ggplot(data=plot_m_BW_ssep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("SSEP")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(23,100,by=5)) +
  scale_y_continuous(breaks=seq(0,4000,by=20))
plot_BW_ssep
```

## Graph altitude X birthweight
```{r}
plot_BW_altitude <- ggplot(data=plot_m_BW_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Altitude (MASL)")+
  ylab("Birthweight (g)")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200)) +
  scale_y_continuous(breaks=seq(0,4000,by=40))
plot_BW_altitude
```

To take into account the fact that we are analysing a huge dataset (n=1,099,368), we calculated Cohen's d. ([calculation and interpreation of d guide](https://easystats.github.io/effectsize/articles/interpret.html#chen2010big)

)

Cohen's d formula:

$d=\frac{beta}{SD}$ and $SD=\sqrt{n}*se$

$d=\frac{beta}{\sqrt{n}*se}$

-   beta: estimate
-   se: standard error
-   n: population/observation size
-   SD: standard deviation

```{r}
#getting the CI 95% and d (interpret only for the non-smooth parameters)
  beta <- coef(m_BW_bam5_2)
  Vb <- vcov(m_BW_bam5_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1099328
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  round(head(my.ci,18), 2)
```

# Stillbirth

```{r echo=FALSE}
m_SB_bam2 <- bam(stillbirth~s(GA_weeks)+ s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2)+ s(mean_Alt_mean2) + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in6)
  summary(m_SB_bam2)
  
  #function to extract the plot information
plot_m_SB_bam2_GA <- GAM_plot_function_binary(m_SB_bam2, 1)
plot_m_SB_bam2_mat_age <- GAM_plot_function_binary(m_SB_bam2, 2)
plot_m_SB_bam2_time <- GAM_plot_function_binary(m_SB_bam2, 3)
plot_m_SB_bam2_month <- GAM_plot_function_binary(m_SB_bam2, 4)
plot_m_SB_bam2_SSEP <- GAM_plot_function_binary(m_SB_bam2, 5)
plot_m_SB_bam2_alt <- GAM_plot_function_binary(m_SB_bam2, 6)

  k.check(m_SB_bam2) 
  concurvity(m_SB_bam2)
```

## Graph gestational age X Stillbirth
```{r}
plot_SB_GA <- ggplot(data=plot_m_SB_bam2_GA)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Gestational age (weeks)")+
  ylab("Stillbirth risk")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,60,by=5))
plot_SB_GA
```

## Graph maternal age X Stillbirth
```{r}
plot_SB_mat_age <- ggplot(data=plot_m_SB_bam2_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Maternal age (years)")+
  ylab("Stillbirth risk")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,60,by=5))
plot_SB_mat_age
```

## Graph time X Stillbirth
```{r}
x_date <-   bevn_eco_in6 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_SB <- plot_m_SB_bam2_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

plot_SB_time <- ggplot(data=plot_data_SB)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Stillbirth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")
plot_SB_time
```

## Graph seasonality X Stillbirth
```{r}
plot_SB_mat_age <- ggplot(data=plot_m_SB_bam2_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Month")+
  ylab("Stillbirth risk")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(1,12,by=5))
plot_SB_mat_age
```

## Graph SSEP X Stillbirth
```{r}
plot_SB_SSEP <- ggplot(data=plot_m_SB_bam2_SSEP)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("SSEP")+
  ylab("Stillbirth risk")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(23,100,by=5))
plot_SB_SSEP
```

## Graph altitude X Stillbirth
```{r}
plot_SB_altitude <- ggplot(data=plot_m_SB_bam2_alt)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Altitude (MASL)")+
  ylab("Stillbirth risk")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(23,100,by=5))
plot_SB_SSEP
```

```{r echo=FALSE}
#table to show OR, confidence interval and Cohen's d
  OR <- exp(coef(m_SB_bam2))
  beta <- coef(m_SB_bam2)
  Vb <- vcov(m_SB_bam2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 15), 2)
```

Time variable (birth_Y_M_num) and mean ssep variable could have been put as linear terms, because the model including them as smoothed terms showed that the relationship between these and stillbirth was linear, but I chose to keep them as smooth variable to have models that look "more alike" between the different outcomes (birthweight, PTB).

# Preterm birth

```{r echo=FALSE}
m_PTB_bam <- bam(PTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7) 
  summary(m_PTB_bam)
  
 # extracting the plot information
plot_m_PTB_bam_BW <- GAM_plot_function_binary(m_PTB_bam, 1)
plot_m_PTB_bam_mat_age <- GAM_plot_function_binary(m_PTB_bam, 2)
plot_m_PTB_bam_time <- GAM_plot_function_binary(m_PTB_bam, 3) 
plot_m_PTB_bam_month <- GAM_plot_function_binary(m_PTB_bam, 4)
plot_m_PTB_bam_sep <- GAM_plot_function_binary(m_PTB_bam, 5)
plot_m_PTB_bam_altitude <- GAM_plot_function_binary(m_PTB_bam, 6) 
  
  k.check(m_PTB_bam) 
  concurvity(m_PTB_bam)
```

## Graph birthweight X preterm birth
DOESNT work probably because still very high BW present in database (9kg --> exclude?)
```{r}
plot_PTB_BW <- ggplot(data=plot_m_PTB_bam_BW)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Birthweight (g)")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,10000,by=1000))

plot_PTB_BW
```

## Graph maternal age X preterm birth
```{r}
plot_PTB_mat_age <- ggplot(data=plot_m_PTB_bam_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Maternal age (years)")+
  ylab("Preterm birth probability")+
  scale_colour_manual('age', values =c("#9557DC"))+
  scale_fill_manual('age', values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5))
plot_PTB_mat_age
```

## Graph time variable X preterm birth
```{r}
x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_PTB <- plot_m_PTB_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

plot_PTB <- ggplot(data=plot_data_PTB)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Timeline (years)")+
  ylab("Preterm birth probability")+
  scale_colour_manual('PTB', values =c("#9557DC"))+
  scale_fill_manual('PTB', values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")
plot_PTB
```

## Graph seasonality X preterm birth
```{r}
plot_PTB_seasonality <- ggplot(data=plot_m_PTB_bam_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Month")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1))
plot_PTB_seasonality
```

## Graph SSEP X preterm birth
```{r}
plot_PTB_seasonality <- ggplot(data=plot_m_PTB_bam_sep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("SSEP")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(23,100,by=5))
plot_PTB_seasonality
```

## Graph altitude X preterm birth
```{r}
plot_PTB_seasonality <- ggplot(data=plot_m_PTB_bam_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("#9557DC"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='#69D8F3')+
  xlab("Altitude (MASL)")+
  ylab("Preterm birth probability")+
  scale_colour_manual(values =c("#9557DC"))+
  scale_fill_manual(values =c("#9557DC"))+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200))
plot_PTB_seasonality
```

## Table for the model's estimates
```{r}
  OR <- exp(coef(m_PTB_bam))
  beta <- coef(m_PTB_bam)
  Vb <- vcov(m_PTB_bam, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  round(head(my.ci, 18), 2)
```
