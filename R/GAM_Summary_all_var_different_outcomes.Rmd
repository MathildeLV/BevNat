---
title: "GAM_all_variables_different_outcomes"
author: "Mathilde Le Vu"
date:  "`r Sys.Date()`"
html_document: 
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

How did neonatal health evolve through time (2007-2020)?

Particularly, did it change during two important crisis: the 2009 economic crisis and the current COVID-19 pandemic?

We focus on the evolution of birthweight and gestational age, and on the rates of stillbirth, preterm birth, lowbirth weight and macrosomia babies.

COVID data will be included soon: hospital cases, mortality. Temperature will also maybe be included.

# Data and Methods

## Data

We used data from the Federal Office of Statistics: Bevnat. It covers:

-   All births that occurred in Switzerland

-   Between 1987 and 2021

## Variables

### Swiss-SEP

Average Swiss neighbourhood index of socioeconomic position (Swiss-SEP 2.0). Swiss-SEP 2.0 indicates the average socioeconomic situation in a municipality. It was developed by the Institute for Social and Preventive Medicine at the University of Bern.

## Exclusions steps

-   As gestational age was only recorded systematically from 2007, we analysed data from this year only
-   Steps of exclusions: see the ppt

Definitions:

-   Preterm birth babies : \<37 weeks

-   Low birthweight babies : \<2500g

-   Macrosomia babies: \>= 4000g

-   "normal" birthweight babies: )2500-4000)

We work with two different datasets:

-   one that includes stillbirth cases to investigate stillbirth outcome: bevn_eco_in6.

-   one that excludes stillbirth cases to investigate birthweight/gestational age/ preterm birth/ low birth weight/ macrosomia outcomes : bevn_eco_in7.

## Characteristics at inclusion and in two other datasets used

-   see tables in html.

## Methods

We built different GAM models, investigating the following outcomes:

-   birthweight as a continuous variable

-   stillbirth : binary yes/no variable

-   gestational age: as a continuous variable, in days

-   preterm birth: binary yes/no variable.

-   low birthweight: binary yes/no variable, comparing LBW babies vs the rest

-   low birthweight: binary yes/no variable, comparing LBW babies vs "normal" birthweight babies

-   macrosomia: binary yes/no variable, comparing macrosomia babies vs "normal" birthweight babies

In the models the variable "birth_Y\_M_num" is used to account for time: it is numerical monthly time, with 1= January 2007 and 168=December 2020.

# Birthweight

We chose this model based on lower AIC and also lower k value for maternal age, which seems more appropriate when looking at the graph.

```{r}
m_BW_bam5_2 <- bam(BW ~ s(GA_weeks) +  s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, data=bevn_eco_in7) 
  summary(m_BW_bam5_2)
  gam.check(m_BW_bam5_2) 
  #plot(m_BW_bam5_2,  select=1, shift = coef(m_BW_bam5_2)[1], shade = TRUE, shade.col = "lightblue") #ga

# extracting the plot information
plot_m_BW_GA <- GAM_plot_function_continuous(m_BW_bam5_2, 1) # GA
plot_m_BW_mat_age <- GAM_plot_function_continuous(m_BW_bam5_2, 2) # mat age
plot_m_BW_time <- GAM_plot_function_continuous(m_BW_bam5_2, 3) #time
plot_m_BW_month <- GAM_plot_function_continuous(m_BW_bam5_2, 4) # seasonality
plot_m_BW_ssep <- GAM_plot_function_continuous(m_BW_bam5_2, 5) # ssep
plot_m_BW_altitude <- GAM_plot_function_continuous(m_BW_bam5_2, 6) # altitude
```

## Graph Gestational age X birthweight

```{r}
plot_BW_GA <- ggplot(data=plot_m_BW_GA)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Gestational age (weeks)")+
  ylab("Birthweight (g)")+
theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom"
    # panel.background=element_rect(fill="white", color="black"),
    # plot.background=element_rect(fill="white", color="black")
    )+ 
    scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
    scale_y_continuous(breaks=seq(0,5000,by=500))  +
theme(axis.title.x = axis.title.x.position)
plot_BW_GA
```

## Graph maternal age variable X BW

```{r}
plot_BW_mat_age <- ggplot(data=plot_m_BW_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)

plot_BW_mat_age
```

## Graph time X birthweight

```{r}
x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_BW <- plot_m_BW_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_BW_time <- ggplot(data=plot_data_BW)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Timeline (years)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3250,3550)) +
  scale_colour_manual('BW',  #colour manual is for the line
                      # labels=c("fully adjusted","95% CI","95% CI"),
                      values =c("#9557DC"))+
  scale_fill_manual('BW',                        # fill is for CI
                    # labels=c("fully adjusted","95% CI","95% CI"),  
                    values =c("#9557DC"))+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(as.POSIXct("2007-01-01"), max(lim2)), #to force labelling from 2007 on the x axis
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
theme(axis.title.x = axis.title.x.position)
plot_BW_time
```

## Graph seasonality X birthweight

```{r}
plot_BW_month <- ggplot(data=plot_m_BW_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_month
```

## Graph SSEP X birthweight

```{r}
plot_BW_ssep <- ggplot(data=plot_m_BW_ssep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("SSEP")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,100,by=5),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_ssep
```

## Graph altitude X birthweight

```{r}
plot_BW_altitude <- ggplot(data=plot_m_BW_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Altitude (MASL)")+
  ylab("Birthweight (g)")+
  coord_cartesian(ylim=c(3160,3380)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200),expand = c(0, 0)) +
  scale_y_continuous(breaks=seq(0,4000,by=50)) +
theme(axis.title.x = axis.title.x.position)
plot_BW_altitude
```

To take into account the fact that we are analysing a huge dataset (n=1,099,368), we calculated Cohen's d. ([calculation and interpreation of d guide](https://easystats.github.io/effectsize/articles/interpret.html#chen2010big)

)

Cohen's d formula:

$d=\frac{beta}{SD}$ and $SD=\sqrt{n}*se$

$d=\frac{beta}{\sqrt{n}*se}$

-   beta: estimate
-   se: standard error
-   n: population/observation size
-   SD: standard deviation

## Table summarizing the birthweight outcome model

```{r}
  beta <- coef(m_BW_bam5_2)
  Vb <- vcov(m_BW_bam5_2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  n <- 1099328
  d <- (abs(beta)/(sqrt(n)*se))
  my.ci <- data.frame(cbind(beta, lci = beta-1.96*se, uci = beta + 1.96*se, d))
  tab_BW_full <- round(head(my.ci,18), 2)
```

```{r}
tab_BW_full['variable'] <- c("Intercept", "Parity (ref: 1)", " ", " ", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_BW_full['category'] <- c(" ", "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_BW_full<-tab_BW_full[, c('variable', "category", "beta", "lci","uci", "d")]

BW_full_gt <- tab_BW_full %>%
  gt()%>%
  tab_header(title="Birthweight GAM") %>%
  tab_spanner(label = "95% CI (g)", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 3, 4, 6, 9, 10, 11,12,13,15,17 )))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(5, 7, 8, 14,16,18)))
BW_full_gt

BW_estimates_whole_model_gt <- BW_full_gt%>%
  gtsave(here("output/tables", "BW_estimates_whole_model_gt.html"))
```

# Stillbirth

```{r echo=FALSE}
m_SB_bam2 <- bam(stillbirth~s(GA_weeks)+ s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2)+ s(mean_Alt_mean2) + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in6)
  summary(m_SB_bam2)
  
  #function to extract the plot information
plot_m_SB_bam2_GA <- GAM_plot_function_binary(m_SB_bam2, 1)
plot_m_SB_bam2_mat_age <- GAM_plot_function_binary(m_SB_bam2, 2)
plot_m_SB_bam2_time <- GAM_plot_function_binary(m_SB_bam2, 3)
plot_m_SB_bam2_month <- GAM_plot_function_binary(m_SB_bam2, 4)
plot_m_SB_bam2_SSEP <- GAM_plot_function_binary(m_SB_bam2, 5)
plot_m_SB_bam2_alt <- GAM_plot_function_binary(m_SB_bam2, 6)

  k.check(m_SB_bam2) 
  concurvity(m_SB_bam2)
```

## Graph gestational age X Stillbirth

```{r}
plot_SB_GA <- ggplot(data=plot_m_SB_bam2_GA)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Gestational age (weeks)")+
  ylab("Stillbirth probability")+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,45,by=5),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_GA
```

## Graph maternal age X Stillbirth

```{r}
plot_SB_mat_age <- ggplot(data=plot_m_SB_bam2_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.0015)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_mat_age
```

## Graph time X Stillbirth

```{r}
x_date <-   bevn_eco_in6 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_SB <- plot_m_SB_bam2_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))

plot_SB_time <- ggplot(data=plot_data_SB)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Timeline (years)")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.0015)) +
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(as.POSIXct("2007-01-01"), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
theme(axis.title.x = axis.title.x.position)
plot_SB_time
```

## Graph seasonality X Stillbirth

```{r}
plot_SB_month <- ggplot(data=plot_m_SB_bam2_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.0015)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_month
```

## Graph SSEP X Stillbirth

```{r}
plot_SB_SSEP <- ggplot(data=plot_m_SB_bam2_SSEP)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("SSEP")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.0015)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,100,by=5),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_SSEP
```

## Graph altitude X Stillbirth

```{r}
plot_SB_altitude <- ggplot(data=plot_m_SB_bam2_alt)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Altitude (MASL)")+
  ylab("Stillbirth probability")+
  coord_cartesian(ylim=c(0.0005,0.0015)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom")+
  scale_x_continuous(breaks=seq(0,2000,by=200),expand = c(0, 0)) +
theme(axis.title.x = axis.title.x.position)
plot_SB_altitude
```

## Table summarizing the stillbirth outcome model

```{r echo=FALSE}
#table to show OR, confidence interval and Cohen's d
  OR <- exp(coef(m_SB_bam2))
  beta <- coef(m_SB_bam2)
  Vb <- vcov(m_SB_bam2, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_SB_full <-  round(head(my.ci, 15), 2)
```

```{r}
#tab_SB_full['variable'] <- c(rownames(tab_SB_full))
tab_SB_full['variable'] <- c("Intercept", "Sex (ref: male)",
                                      "Urban (ref: rural)",
                                      "Language region (ref: German)", " ", 
                                      "Maternal nationality (ref: Swiss)", " ", " ",
                                      " ", " ",
                                      "Civil status (ref: married)",
                                      "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                                      "COVID first wave (ref: 0)", 
                                      "COVID second wave (ref: 0)")

    tab_SB_full['category'] <- c(" ", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern and Central America", "Single", " ", " "," ", " ")
    tab_SB_full<-tab_SB_full[, c('variable', "category", "OR", "lci","uci", "d")]

SB_full_gt <- tab_SB_full %>%
  gt()%>%
  tab_header(title="Stillbirth GAM") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 4, 5, 11, 13, 15)))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(3, 6, 7, 8, 9, 10, 12, 14)))
SB_full_gt

SB_estimates_whole_model_gt <- SB_full_gt%>%
  gtsave(here("output/tables", "SB_estimates_whole_model_gt.html"))
```

Time variable (birth_Y\_M_num) and mean ssep variable could have been put as linear terms, because the model including them as smoothed terms showed that the relationship between these and stillbirth was linear, but I chose to keep them as smooth variable to have models that look "more alike" between the different outcomes (birthweight, PTB).

# Preterm birth

```{r echo=FALSE}
m_PTB_bam <- bam(PTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7) 
  summary(m_PTB_bam)
    #plot(m_PTB_bam, trans = plogis, select=2, shift = coef(m_PTB_bam)[1], shade = TRUE, shade.col = "lightblue") #BW
 # extracting the plot information
plot_m_PTB_bam_BW <- GAM_plot_function_binary(m_PTB_bam, 1)
plot_m_PTB_bam_mat_age <- GAM_plot_function_binary(m_PTB_bam, 2)
plot_m_PTB_bam_time <- GAM_plot_function_binary(m_PTB_bam, 3) 
plot_m_PTB_bam_month <- GAM_plot_function_binary(m_PTB_bam, 4)
plot_m_PTB_bam_sep <- GAM_plot_function_binary(m_PTB_bam, 5)
plot_m_PTB_bam_altitude <- GAM_plot_function_binary(m_PTB_bam, 6) 
  
  k.check(m_PTB_bam) 
  concurvity(m_PTB_bam)
```

## Graph birthweight X preterm birth

```{r}
plot_PTB_BW <- ggplot(data=plot_m_PTB_bam_BW)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Birthweight (g)")+
  ylab("Preterm birth probability")+
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(200,7500,by=1000),expand = c(0, 0))  +
  theme(axis.title.x = axis.title.x.position)

plot_PTB_BW
```

## Graph maternal age X preterm birth

```{r}
plot_PTB_mat_age <- ggplot(data=plot_m_PTB_bam_mat_age)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Maternal age (years)")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.010,0.04)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,60,by=5),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_mat_age
```

## Graph time variable X preterm birth

```{r}
x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_PTB <- plot_m_PTB_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_PTB <- ggplot(data=plot_data_PTB)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Timeline (years)")+
  ylab("Preterm birth probability")+
  coord_cartesian(ylim=c(0.005,0.025)) +
  scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(as.POSIXct("2007-01-01"), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
theme(axis.title.x = axis.title.x.position)

plot_PTB
```

## Graph seasonality X preterm birth

```{r}
plot_PTB_seasonality <- ggplot(data=plot_m_PTB_bam_month)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Month")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.010,0.04)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(1,12,by=1),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_seasonality
```

## Graph SSEP X preterm birth

```{r}
plot_PTB_SSEP <- ggplot(data=plot_m_PTB_bam_sep)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("SSEP")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.010,0.04)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,100,by=5),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_SSEP
```

## Graph altitude X preterm birth

```{r}
plot_PTB_altitude <- ggplot(data=plot_m_PTB_bam_altitude)+
  geom_line(aes(x=(x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=(x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Altitude (MASL)")+
  ylab("Preterm birth probability")+
  theme_bw()+
  coord_cartesian(ylim=c(0.010,0.04)) +
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  scale_x_continuous(breaks=seq(0,2000,by=200),expand = c(0, 0)) +
  theme(axis.title.x = axis.title.x.position)
plot_PTB_altitude
```

## Table summarizing the preterm birth outcome model

```{r}
  OR <- exp(coef(m_PTB_bam))
  beta <- coef(m_PTB_bam)
  Vb <- vcov(m_PTB_bam, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_PTB_full <- round(head(my.ci, 18), 2)
```

```{r}
tab_PTB_full['variable'] <- c("Intercept", "Parity (ref: 1)", " ", " ", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_PTB_full['category'] <- c(" ", "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_PTB_full<-tab_PTB_full[, c('variable', "category", "OR", "lci","uci", "d")]

PTB_full_gt <- tab_PTB_full %>%
  gt()%>%
  tab_header(title="Preterm birth GAM") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 3, 4, 6, 9, 10, 11,12,13,15,17 )))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(5, 7, 8, 14,16,18)))
PTB_full_gt

PTB_estimates_whole_model_gt <- PTB_full_gt%>%
  gtsave(here("output/tables", "PTB_estimates_whole_model_gt.html"))
```

# Very PTB (<32 weeks of GA)

```{r echo=FALSE}
m_VPTB_bam <- bam(VPTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7) 
  summary(m_VPTB_bam)
plot_m_VPTB_bam_BW <- GAM_plot_function_binary(m_VPTB_bam, 1)
plot_m_VPTB_bam_mat_age <- GAM_plot_function_binary(m_VPTB_bam, 2)
plot_m_VPTB_bam_time <- GAM_plot_function_binary(m_VPTB_bam, 3) 
plot_m_VPTB_bam_month <- GAM_plot_function_binary(m_VPTB_bam, 4)
plot_m_VPTB_bam_sep <- GAM_plot_function_binary(m_VPTB_bam, 5)
plot_m_VPTB_bam_altitude <- GAM_plot_function_binary(m_VPTB_bam, 6) 
  
  k.check(m_VPTB_bam) 
  concurvity(m_VPTB_bam)
```

## Graph time variable X very preterm birth

```{r}
x_date <-   bevn_eco_in7 %>% #careful, mayhave to change the dataset if I later work with smaller time ranges!
  select(birth_Y_M, birth_Y_M_num) %>%
  distinct(birth_Y_M, .keep_all = TRUE) %>%
  rename(x=birth_Y_M_num)

plot_data_VPTB <- plot_m_VPTB_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_VPTB <- ggplot(data=plot_data_VPTB)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Timeline (years)")+
  ylab("Very Preterm birth probability")+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  ggtitle("VPTB (<32 weeks of GA) risk through time") +
  theme(axis.title.x = axis.title.x.position)
plot_VPTB
```


## Table summarizing the very preterm birth outcome model

```{r}
  OR <- exp(coef(m_VPTB_bam))
  beta <- coef(m_VPTB_bam)
  Vb <- vcov(m_VPTB_bam, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_VPTB_full <- round(head(my.ci, 18), 2)
```

```{r}
tab_VPTB_full['variable'] <- c("Intercept", "Parity (ref: 1)", " ", " ", 
                              "Sex (ref: male)", "Urban (ref: rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_VPTB_full['category'] <- c(" ", "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_VPTB_full<-tab_VPTB_full[, c('variable', "category", "OR", "lci","uci", "d")]

VPTB_full_gt <- tab_VPTB_full %>%
  gt()%>%
  tab_header(title="Very preterm birth GAM") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 3, 4, 6, 9, 10, 11,12,13,15,17 )))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(5, 7, 8, 14,16,18)))
VPTB_full_gt

VPTB_estimates_whole_model_gt <- VPTB_full_gt%>%
  gtsave(here("output/tables", "VPTB_estimates_whole_model_gt.html"))
```

# Early PTB (32-34 weeks of GA)

```{r echo=FALSE}
m_EPTB_bam <- bam(EPTB~ s(BW) + s(mat_age) + s(birth_Y_M_num) + s(month, bs="cc") + s(mean_ssep2) + s(mean_Alt_mean2)+ parity_cat + sex + Urban3 + Language + mother_nationality_cat2 + civil_status3 + HW + GR + COVID_first_wave + COVID_second_wave, family="binomial", data=bevn_eco_in7) 
  summary(m_EPTB_bam)
plot_m_EPTB_bam_BW <- GAM_plot_function_binary(m_EPTB_bam, 1)
plot_m_EPTB_bam_mat_age <- GAM_plot_function_binary(m_EPTB_bam, 2)
plot_m_EPTB_bam_time <- GAM_plot_function_binary(m_EPTB_bam, 3) 
plot_m_EPTB_bam_month <- GAM_plot_function_binary(m_EPTB_bam, 4)
plot_m_EPTB_bam_sep <- GAM_plot_function_binary(m_EPTB_bam, 5)
plot_m_EPTB_bam_altitude <- GAM_plot_function_binary(m_EPTB_bam, 6) 
  
  k.check(m_EPTB_bam) 
  concurvity(m_EPTB_bam)
```

## Graph time variable X early preterm birth
```{r}
plot_data_EPTB <- plot_m_EPTB_bam_time %>%
  mutate(x=round(x,0)) %>%
  left_join(x_date) %>%
  mutate(date_x= ymd(paste0(birth_Y_M,"-01")))
lim1 <- as.POSIXct(ymd("2007-01-01"))
lim2 <- as.POSIXct(ymd("2021-12-01"))

plot_EPTB <- ggplot(data=plot_data_EPTB)+
  geom_line(aes(x=as.POSIXct(date_x),y=fit),lwd=lwdline, color=("black"))+
  geom_ribbon(aes(x=as.POSIXct(date_x),ymin=CIl,ymax=CIu),alpha=0.15,lwd=lwdline, fill='black')+
  xlab("Timeline (years)")+
  ylab("Early Preterm birth probability")+
   scale_x_datetime( breaks = date_breaks("12 month"), 
                    labels = label_date_short(),
                    limits =c(min(lim1), max(lim2)),
                    expand = c(0,0)) +
  theme_bw()+
  theme(axis.text.y=element_text(color="black",size=size_axis),
        axis.text.x=element_text(color="black",size=size_axis,angle=45,hjust=1),
        axis.title=element_text(size=size_axis_title),
        legend.text=element_text(size=size_legend),
        legend.title=element_text(size=size_legend_title),
        legend.position="bottom") +
  ggtitle("EPTB (32-34 weeks of GA) risk through time") +
  theme(axis.title.x = axis.title.x.position)
plot_EPTB
```

## Table summarizing the early preterm birth outcome model

```{r}
  OR <- exp(coef(m_EPTB_bam))
  beta <- coef(m_EPTB_bam)
  Vb <- vcov(m_EPTB_bam, unconditional = TRUE)
  se <- sqrt(diag(Vb))
  lci <- exp(beta-1.96*se)
  uci <- exp(beta+1.96*se)
  d <- abs(beta)/1.81
  my.ci <- data.frame(cbind(OR, lci, uci, d))
  tab_EPTB_full <- round(head(my.ci, 18), 2)
```

```{r}
tab_EPTB_full['variable'] <- c("Intercept", "Parity (ref: 1)", " ", " ", 
                              "Sex (ref:male)", "Urban (ref:rural)",
                              "Language region (ref: German)", " ", 
                              "Maternal nationality (ref: Swiss)", " ", " ",
                              " ", " ",
                              "Civil status (ref: married)",
                              "Heatwave (ref: 0)", "Great Recession (ref: 0)",
                              "COVID first wave (ref: 0)", 
                              "COVID second wave (ref: 0)")

    tab_EPTB_full['category'] <- c(" ", "2", "3", ">3", "Female", "Urban", "French", "Italian", 
                            "Africa", "Asia", "Europe", "Northern America",
                            "Southern/Central America", "Single", " ", " "," ", " ")
    tab_EPTB_full<-tab_EPTB_full[, c('variable', "category", "OR", "lci","uci", "d")]

EPTB_full_gt <- tab_EPTB_full %>%
  gt()%>%
  tab_header(title="Early preterm birth GAM") %>%
  tab_spanner(label = "95% CI", columns = c(lci, uci)) %>%
  tab_style(
    style = list(
          cell_fill(color = "#E0E0E0")
        ),
        locations = cells_body(rows=c(2, 3, 4, 6, 9, 10, 11,12,13,15,17 )))%>%
    tab_style(
    style = list(
     cell_fill(color = "#F2F0F0")),
        locations = cells_body(rows=c(5, 7, 8, 14,16,18)))
EPTB_full_gt

EPTB_estimates_whole_model_gt <- EPTB_full_gt%>%
  gtsave(here("output/tables", "EPTB_estimates_whole_model_gt.html"))
```
